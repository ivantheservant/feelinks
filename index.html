<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feelinks - ÊÉÖÊÑüÊé¢Á¥¢Âç°ÁâåÈÅäÊà≤</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            padding: 40px;
        }

        /* Language Toggle */
        .language-toggle {
            text-align: center;
            margin-bottom: 30px;
        }

        .language-toggle button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 30px;
            margin: 0 5px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        .language-toggle button:hover {
            background: #764ba2;
            transform: translateY(-2px);
        }

        .language-toggle button.active {
            background: #764ba2;
            box-shadow: 0 5px 15px rgba(118, 75, 162, 0.4);
        }

        /* Profile Section */
        .profile-section {
            margin-bottom: 40px;
        }

        .profile-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .profile-header h2 {
            color: #333;
            font-size: 1.8em;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        .btn:hover {
            background: #764ba2;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-danger {
            background: #e74c3c;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        /* Profile Grid */
        .profile-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .profile-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .profile-card:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
            transform: translateY(-5px);
        }

        .profile-card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea10 0%, #764ba210 100%);
        }

        .profile-card h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.3em;
        }

        .profile-card .meta {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 8px;
        }

        .profile-card .description {
            color: #888;
            font-size: 0.85em;
            line-height: 1.4;
            margin-top: 10px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-content h2 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: #333;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        /* Game Section */
        .game-section {
            display: none;
        }

        .game-section.active {
            display: block;
        }

        .game-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .question-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 30px;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .question-display h3 {
            font-size: 2em;
            line-height: 1.5;
        }

        .question-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .question-info .category {
            background: #667eea;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 500;
        }

        .question-info .counter {
            color: #666;
            font-size: 1.1em;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
        }

        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Error Message */
        .error-message {
            background: #ffe5e5;
            border: 2px solid #ff4444;
            color: #cc0000;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        /* Success Message */
        .success-message {
            background: #e5ffe5;
            border: 2px solid #44ff44;
            color: #00cc00;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .main-content {
                padding: 20px;
            }

            .profile-grid {
                grid-template-columns: 1fr;
            }

            .question-display h3 {
                font-size: 1.5em;
            }

            .game-controls {
                flex-direction: column;
            }

            .game-controls .btn {
                width: 100%;
            }
        }

        /* Category Filter */
        .category-filter {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .category-filter button {
            background: #f0f0f0;
            border: 2px solid #e0e0e0;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .category-filter button:hover {
            border-color: #667eea;
        }

        .category-filter button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚ù§Ô∏è Feelinks</h1>
            <p id="subtitle">ÊÉÖÊÑüÊé¢Á¥¢Âç°ÁâåÈÅäÊà≤ - AI È©ÖÂãïÁâàÊú¨</p>
        </div>

        <div class="main-content">
            <!-- Language Toggle -->
            <div class="language-toggle">
                <button id="btn-tc" class="active" onclick="switchLanguage('tc')">ÁπÅÈ´î‰∏≠Êñá</button>
                <button id="btn-en" onclick="switchLanguage('en')">English</button>
            </div>

            <!-- Profile Selection Section -->
            <div id="profile-section" class="profile-section">
                <div class="profile-header">
                    <h2 id="profile-title">ÈÅ∏Êìá Profile</h2>
                    <button class="btn" onclick="showCreateProfileModal()" id="btn-create-profile">
                        ‚ûï ÂâµÂª∫Êñ∞ Profile
                    </button>
                </div>

                <div id="loading" class="loading" style="display: none;">
                    <div class="loading-spinner"></div>
                    <p id="loading-text">ËºâÂÖ•‰∏≠...</p>
                </div>

                <div id="error-message" class="error-message" style="display: none;"></div>

                <div id="profile-grid" class="profile-grid">
                    <!-- Profiles will be loaded here -->
                </div>

                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn" onclick="startGame()" id="btn-start-game" disabled>
                        üéÆ ÈñãÂßãÈÅäÊà≤
                    </button>
                </div>
            </div>

            <!-- Game Section -->
            <div id="game-section" class="game-section">
                <div class="game-controls">
                    <button class="btn" onclick="backToProfiles()" id="btn-back">
                        ‚¨ÖÔ∏è ËøîÂõû
                    </button>
                    <button class="btn" onclick="drawQuestion()" id="btn-draw">
                        üé≤ ÊäΩÂç°
                    </button>
                    <button class="btn" onclick="nextQuestion()" id="btn-next" disabled>
                        ‚û°Ô∏è ‰∏ã‰∏ÄÂºµ
                    </button>
                    <button class="btn btn-danger" onclick="deleteCurrentProfile()" id="btn-delete">
                        üóëÔ∏è Âà™Èô§Ê≠§ Profile
                    </button>
                </div>

                <div id="category-filter" class="category-filter" style="display: none;">
                    <!-- Categories will be loaded here -->
                </div>

                <div class="question-info">
                    <span class="category" id="current-category">Category</span>
                    <span class="counter" id="question-counter">0/0</span>
                </div>

                <div class="question-display">
                    <h3 id="current-question">ÈªûÊìä„ÄåÊäΩÂç°„ÄçÈñãÂßã</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Profile Modal -->
    <div id="create-profile-modal" class="modal">
        <div class="modal-content">
            <h2 id="modal-title">ÂâµÂª∫Êñ∞ Profile</h2>
            <form id="create-profile-form" onsubmit="createProfile(event)">
                <div class="form-group">
                    <label for="profile-name" id="label-name">Profile ÂêçÁ®±Ôºö</label>
                    <input type="text" id="profile-name" required maxlength="50">
                </div>

                <div class="form-group">
                    <label for="profile-type" id="label-type">È°ûÂûãÔºö</label>
                    <select id="profile-type" required>
                        <option value="Individual">ÂÄã‰∫∫ (Individual)</option>
                        <option value="Couple">ÊÉÖ‰æ∂ (Couple)</option>
                        <option value="Family">ÂÆ∂Â∫≠ (Family)</option>
                        <option value="Friends">ÊúãÂèã (Friends)</option>
                        <option value="Team">ÂúòÈöä (Team)</option>
                        <option value="Other">ÂÖ∂‰ªñ (Other)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="profile-language" id="label-language">Ë™ûË®ÄÔºö</label>
                    <select id="profile-language" required>
                        <option value="tc">ÁπÅÈ´î‰∏≠Êñá</option>
                        <option value="en">English</option>
                        <option value="both">ÈõôË™û (Both)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="profile-description" id="label-description">ÊèèËø∞ (ÈÅ∏Â°´)Ôºö</label>
                    <textarea id="profile-description" maxlength="200"></textarea>
                </div>

                <div id="modal-error" class="error-message" style="display: none;"></div>
                <div id="modal-success" class="success-message" style="display: none;"></div>

                <div class="modal-buttons">
                    <button type="button" class="btn" onclick="closeCreateProfileModal()" id="btn-cancel">
                        ÂèñÊ∂à
                    </button>
                    <button type="submit" class="btn" id="btn-submit">
                        ÂâµÂª∫
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ========================================
        // CONFIGURATION
        // ========================================
        const API_URL = 'https://script.google.com/macros/s/AKfycbzP6lD_L7dU3df2JJ78cP4nAamnawAyxaoIR-PxOToBZncf4-FHicmY2zXXZEwW2GpM/exec';

        // ========================================
        // STATE
        // ========================================
        let currentLanguage = 'tc';
        let profiles = [];
        let selectedProfile = null;
        let currentQuestions = [];
        let currentQuestionIndex = -1;
        let selectedCategories = [];

        // ========================================
        // TRANSLATIONS
        // ========================================
        const translations = {
            tc: {
                subtitle: 'ÊÉÖÊÑüÊé¢Á¥¢Âç°ÁâåÈÅäÊà≤ - AI È©ÖÂãïÁâàÊú¨',
                profileTitle: 'ÈÅ∏Êìá Profile',
                btnCreateProfile: '‚ûï ÂâµÂª∫Êñ∞ Profile',
                loadingText: 'ËºâÂÖ•‰∏≠...',
                btnStartGame: 'üéÆ ÈñãÂßãÈÅäÊà≤',
                btnBack: '‚¨ÖÔ∏è ËøîÂõû',
                btnDraw: 'üé≤ ÊäΩÂç°',
                btnNext: '‚û°Ô∏è ‰∏ã‰∏ÄÂºµ',
                btnDelete: 'üóëÔ∏è Âà™Èô§Ê≠§ Profile',
                defaultQuestion: 'ÈªûÊìä„ÄåÊäΩÂç°„ÄçÈñãÂßã',
                modalTitle: 'ÂâµÂª∫Êñ∞ Profile',
                labelName: 'Profile ÂêçÁ®±Ôºö',
                labelType: 'È°ûÂûãÔºö',
                labelLanguage: 'Ë™ûË®ÄÔºö',
                labelDescription: 'ÊèèËø∞ (ÈÅ∏Â°´)Ôºö',
                btnCancel: 'ÂèñÊ∂à',
                btnSubmit: 'ÂâµÂª∫',
                typeIndividual: 'ÂÄã‰∫∫ (Individual)',
                typeCouple: 'ÊÉÖ‰æ∂ (Couple)',
                typeFamily: 'ÂÆ∂Â∫≠ (Family)',
                typeFriends: 'ÊúãÂèã (Friends)',
                typeTeam: 'ÂúòÈöä (Team)',
                typeOther: 'ÂÖ∂‰ªñ (Other)',
                langTC: 'ÁπÅÈ´î‰∏≠Êñá',
                langEN: 'English',
                langBoth: 'ÈõôË™û (Both)',
                questionCount: 'È°å',
                errorLoadProfiles: 'ËºâÂÖ• Profiles Â§±ÊïóÔºåË´ãÈáçÊñ∞Êï¥ÁêÜÈ†ÅÈù¢',
                errorSelectProfile: 'Ë´ãÂÖàÈÅ∏Êìá‰∏ÄÂÄã Profile',
                errorNoQuestions: 'Ê≠§ Profile ÈÇÑÊ≤íÊúâ‰ªª‰ΩïÂïèÈ°å',
                successProfileCreated: 'Profile ÂâµÂª∫ÊàêÂäüÔºÅÊ≠£Âú®ÁîüÊàêÂïèÈ°å...',
                confirmDelete: 'Á¢∫ÂÆöË¶ÅÂà™Èô§Ê≠§ Profile ÂóéÔºüÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©Âéü„ÄÇ'
            },
            en: {
                subtitle: 'Emotional Exploration Card Game - AI Powered',
                profileTitle: 'Select Profile',
                btnCreateProfile: '‚ûï Create New Profile',
                loadingText: 'Loading...',
                btnStartGame: 'üéÆ Start Game',
                btnBack: '‚¨ÖÔ∏è Back',
                btnDraw: 'üé≤ Draw Card',
                btnNext: '‚û°Ô∏è Next',
                btnDelete: 'üóëÔ∏è Delete Profile',
                defaultQuestion: 'Click "Draw Card" to start',
                modalTitle: 'Create New Profile',
                labelName: 'Profile Name:',
                labelType: 'Type:',
                labelLanguage: 'Language:',
                labelDescription: 'Description (Optional):',
                btnCancel: 'Cancel',
                btnSubmit: 'Create',
                typeIndividual: 'Individual',
                typeCouple: 'Couple',
                typeFamily: 'Family',
                typeFriends: 'Friends',
                typeTeam: 'Team',
                typeOther: 'Other',
                langTC: 'Traditional Chinese',
                langEN: 'English',
                langBoth: 'Both',
                questionCount: 'Questions',
                errorLoadProfiles: 'Failed to load profiles. Please refresh the page.',
                errorSelectProfile: 'Please select a profile first',
                errorNoQuestions: 'This profile has no questions yet',
                successProfileCreated: 'Profile created successfully! Generating questions...',
                confirmDelete: 'Are you sure you want to delete this profile? This cannot be undone.'
            }
        };

        // ========================================
        // LANGUAGE SWITCHING
        // ========================================
        function switchLanguage(lang) {
            currentLanguage = lang;
            
            // Update button states
            document.getElementById('btn-tc').classList.toggle('active', lang === 'tc');
            document.getElementById('btn-en').classList.toggle('active', lang === 'en');
            
            // Update all text
            updateUIText();
            
            // If in game, update current question display
            if (currentQuestionIndex >= 0 && currentQuestions.length > 0) {
                displayCurrentQuestion();
            }
        }

        function updateUIText() {
            const t = translations[currentLanguage];
            
            document.getElementById('subtitle').textContent = t.subtitle;
            document.getElementById('profile-title').textContent = t.profileTitle;
            document.getElementById('btn-create-profile').textContent = t.btnCreateProfile;
            document.getElementById('loading-text').textContent = t.loadingText;
            document.getElementById('btn-start-game').textContent = t.btnStartGame;
            document.getElementById('btn-back').textContent = t.btnBack;
            document.getElementById('btn-draw').textContent = t.btnDraw;
            document.getElementById('btn-next').textContent = t.btnNext;
            document.getElementById('btn-delete').textContent = t.btnDelete;
            document.getElementById('modal-title').textContent = t.modalTitle;
            document.getElementById('label-name').textContent = t.labelName;
            document.getElementById('label-type').textContent = t.labelType;
            document.getElementById('label-language').textContent = t.labelLanguage;
            document.getElementById('label-description').textContent = t.labelDescription;
            document.getElementById('btn-cancel').textContent = t.btnCancel;
            document.getElementById('btn-submit').textContent = t.btnSubmit;
            
            if (currentQuestionIndex < 0) {
                document.getElementById('current-question').textContent = t.defaultQuestion;
            }
            
            // Update select options
            updateSelectOptions();
        }

        function updateSelectOptions() {
            const t = translations[currentLanguage];
            const typeSelect = document.getElementById('profile-type');
            typeSelect.options[0].text = t.typeIndividual;
            typeSelect.options[1].text = t.typeCouple;
            typeSelect.options[2].text = t.typeFamily;
            typeSelect.options[3].text = t.typeFriends;
            typeSelect.options[4].text = t.typeTeam;
            typeSelect.options[5].text = t.typeOther;
            
            const langSelect = document.getElementById('profile-language');
            langSelect.options[0].text = t.langTC;
            langSelect.options[1].text = t.langEN;
            langSelect.options[2].text = t.langBoth;
        }

        // ========================================
        // API CALLS
        // ========================================
        // ‚îÄ‚îÄ helper: all requests go as GET to avoid CORS preflight ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function apiCall(params) {
            const url = new URL(API_URL);
            Object.entries(params).forEach(([k, v]) => url.searchParams.set(k, v));
            const response = await fetch(url.toString());
            return response.json();
        }

        async function fetchProfiles() {
            showLoading(true);
            try {
                // Fix: correct action name + use GET to avoid CORS preflight
                const data = await apiCall({ action: 'listProfiles' });

                if (data.success) {          // Fix: backend returns { success: true }
                    profiles = data.profiles;
                    displayProfiles();
                } else {
                    console.error('listProfiles failed:', data.error);
                    showError(translations[currentLanguage].errorLoadProfiles);
                }
            } catch (error) {
                console.error('Error fetching profiles:', error);
                showError(translations[currentLanguage].errorLoadProfiles);
            } finally {
                showLoading(false);
            }
        }

        async function createProfileAPI(profileData) {
            try {
                // Fix: use GET with JSON-encoded data to avoid CORS preflight
                const data = await apiCall({
                    action: 'createProfile',
                    data: JSON.stringify(profileData)
                });
                return data;
            } catch (error) {
                console.error('Error creating profile:', error);
                return { success: false, error: error.message };
            }
        }

        async function deleteProfileAPI(profileId) {
            try {
                // Fix: use GET to avoid CORS preflight
                const data = await apiCall({
                    action: 'deleteProfile',
                    profileId: profileId
                });
                return data;
            } catch (error) {
                console.error('Error deleting profile:', error);
                return { success: false, error: error.message };
            }
        }

        async function fetchQuestions(profileId) {
            try {
                // Fix: correct action is getProfile (no getQuestions action exists)
                const data = await apiCall({ action: 'getProfile', profileId: profileId });
                if (!data.success) {
                    return { success: false, error: data.error || 'Failed to load profile' };
                }
                // Fix: backend returns questions as { category: [{tc, en}] }
                // Flatten to array of { Question_TC, Question_EN, Category } for game
                const flat = [];
                const questionsObj = data.questions || {};
                for (const [category, qs] of Object.entries(questionsObj)) {
                    for (const q of qs) {
                        flat.push({ Question_TC: q.tc, Question_EN: q.en || '', Category: category });
                    }
                }
                return { success: true, questions: flat };
            } catch (error) {
                console.error('Error fetching questions:', error);
                return { success: false, error: error.message };
            }
        }

        // ========================================
        // UI FUNCTIONS
        // ========================================
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function showModalError(message) {
            const errorDiv = document.getElementById('modal-error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function showModalSuccess(message) {
            const successDiv = document.getElementById('modal-success');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 3000);
        }

        function displayProfiles() {
            const grid = document.getElementById('profile-grid');
            grid.innerHTML = '';
            
            if (profiles.length === 0) {
                grid.innerHTML = '<p style="text-align: center; color: #666;">Â∞öÊú™Êúâ‰ªª‰Ωï ProfileÔºåË´ãÂâµÂª∫‰∏ÄÂÄãÊñ∞ÁöÑÔºÅ</p>';
                return;
            }
            
            profiles.forEach(profile => {
                const card = document.createElement('div');
                card.className = 'profile-card';
                card.onclick = () => selectProfile(profile.id);   // Fix: camelCase id
                
                const questionCountText = currentLanguage === 'tc' ? 'È°å' : 'Questions';
                
                card.innerHTML = `
                    <h3>${profile.name}</h3>
                    <div class="meta">
                        üìã ${profile.type} | üåê ${(profile.language || '').toUpperCase()} | üìù ${profile.questionCount} ${questionCountText}
                    </div>
                    ${profile.description ? `<div class="description">${profile.description}</div>` : ''}
                `;
                
                grid.appendChild(card);
            });
        }

        function selectProfile(profileId) {
            // Remove previous selection
            document.querySelectorAll('.profile-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Find and select new profile
            const profileIndex = profiles.findIndex(p => p.id === profileId);
            if (profileIndex >= 0) {
                selectedProfile = profiles[profileIndex];
                document.querySelectorAll('.profile-card')[profileIndex].classList.add('selected');
                document.getElementById('btn-start-game').disabled = false;
            }
        }

        // ========================================
        // PROFILE MODAL
        // ========================================
        function showCreateProfileModal() {
            document.getElementById('create-profile-modal').classList.add('show');
            document.getElementById('create-profile-form').reset();
            document.getElementById('modal-error').style.display = 'none';
            document.getElementById('modal-success').style.display = 'none';
        }

        function closeCreateProfileModal() {
            document.getElementById('create-profile-modal').classList.remove('show');
        }

        async function createProfile(event) {
            event.preventDefault();
            
            const name = document.getElementById('profile-name').value.trim();
            const type = document.getElementById('profile-type').value;
            const language = document.getElementById('profile-language').value;
            const description = document.getElementById('profile-description').value.trim();
            
            if (!name) {
                showModalError('Ë´ãËº∏ÂÖ• Profile ÂêçÁ®±');
                return;
            }
            
            const profileData = {
                name,
                type,
                language,
                description
            };
            
            // Disable submit button
            const submitBtn = document.getElementById('btn-submit');
            submitBtn.disabled = true;
            submitBtn.textContent = currentLanguage === 'tc' ? 'ÂâµÂª∫‰∏≠...' : 'Creating...';
            
            const result = await createProfileAPI(profileData);
            
            if (result.success) {   // Fix: backend returns { success: true }
                showModalSuccess(translations[currentLanguage].successProfileCreated);
                
                // Wait a bit then close modal and refresh
                setTimeout(() => {
                    closeCreateProfileModal();
                    fetchProfiles();
                }, 2000);
            } else {
                showModalError(result.error || 'Failed to create profile');   // Fix: .error not .message
                submitBtn.disabled = false;
                submitBtn.textContent = translations[currentLanguage].btnSubmit;
            }
        }

        // ========================================
        // GAME FUNCTIONS
        // ========================================
        async function startGame() {
            if (!selectedProfile) {
                showError(translations[currentLanguage].errorSelectProfile);
                return;
            }
            
            // Fetch questions
            showLoading(true);
            const result = await fetchQuestions(selectedProfile.id);   // Fix: camelCase id
            showLoading(false);
            
            if (result.success) {   // Fix: backend returns { success: true }
                currentQuestions = result.questions;
                
                if (currentQuestions.length === 0) {
                    showError(translations[currentLanguage].errorNoQuestions);
                    return;
                }
                
                // Reset game state
                currentQuestionIndex = -1;
                selectedCategories = [];
                
                // Setup categories
                setupCategoryFilter();
                
                // Switch to game view
                document.getElementById('profile-section').classList.remove('active');
                document.getElementById('game-section').classList.add('active');
                
                // Reset question display
                document.getElementById('current-question').textContent = translations[currentLanguage].defaultQuestion;
                updateQuestionCounter();
            } else {
                showError(result.error || 'Failed to load questions');
            }
        }

        function setupCategoryFilter() {
            // Get unique categories
            const categories = [...new Set(currentQuestions.map(q => q.Category))].sort();
            
            const filterDiv = document.getElementById('category-filter');
            filterDiv.innerHTML = '';
            
            if (categories.length > 1) {
                filterDiv.style.display = 'flex';
                
                // Add "All" button
                const allBtn = document.createElement('button');
                allBtn.textContent = currentLanguage === 'tc' ? 'ÂÖ®ÈÉ®' : 'All';
                allBtn.className = 'active';
                allBtn.onclick = () => toggleCategory(null, allBtn);
                filterDiv.appendChild(allBtn);
                
                // Add category buttons
                categories.forEach(cat => {
                    const btn = document.createElement('button');
                    btn.textContent = cat;
                    btn.onclick = () => toggleCategory(cat, btn);
                    filterDiv.appendChild(btn);
                });
            }
        }

        function toggleCategory(category, button) {
            if (category === null) {
                // "All" button clicked
                selectedCategories = [];
                document.querySelectorAll('#category-filter button').forEach(btn => {
                    btn.classList.toggle('active', btn === button);
                });
            } else {
                // Specific category clicked
                const allBtn = document.querySelector('#category-filter button:first-child');
                allBtn.classList.remove('active');
                
                button.classList.toggle('active');
                
                if (button.classList.contains('active')) {
                    selectedCategories.push(category);
                } else {
                    selectedCategories = selectedCategories.filter(c => c !== category);
                }
                
                // If no categories selected, activate "All"
                if (selectedCategories.length === 0) {
                    allBtn.classList.add('active');
                }
            }
        }

        function drawQuestion() {
            // Get available questions
            let availableQuestions = currentQuestions;
            
            if (selectedCategories.length > 0) {
                availableQuestions = currentQuestions.filter(q => 
                    selectedCategories.includes(q.Category)
                );
            }
            
            if (availableQuestions.length === 0) {
                showError('No questions available in selected categories');
                return;
            }
            
            // Random selection
            currentQuestionIndex = Math.floor(Math.random() * availableQuestions.length);
            const questionData = availableQuestions[currentQuestionIndex];
            
            // Find the actual index in currentQuestions array
            currentQuestionIndex = currentQuestions.indexOf(questionData);
            
            displayCurrentQuestion();
            document.getElementById('btn-next').disabled = false;
        }

        function nextQuestion() {
            currentQuestionIndex = (currentQuestionIndex + 1) % currentQuestions.length;
            displayCurrentQuestion();
        }

        function displayCurrentQuestion() {
            if (currentQuestionIndex < 0 || currentQuestions.length === 0) return;
            
            const question = currentQuestions[currentQuestionIndex];
            const questionText = currentLanguage === 'tc' ? question.Question_TC : question.Question_EN;
            
            document.getElementById('current-question').textContent = questionText;
            document.getElementById('current-category').textContent = question.Category;
            updateQuestionCounter();
        }

        function updateQuestionCounter() {
            const counter = document.getElementById('question-counter');
            if (currentQuestionIndex >= 0) {
                counter.textContent = `${currentQuestionIndex + 1}/${currentQuestions.length}`;
            } else {
                counter.textContent = `0/${currentQuestions.length}`;
            }
        }

        function backToProfiles() {
            document.getElementById('game-section').classList.remove('active');
            document.getElementById('profile-section').classList.add('active');
            
            // Reset states
            currentQuestions = [];
            currentQuestionIndex = -1;
            document.getElementById('btn-next').disabled = true;
        }

        async function deleteCurrentProfile() {
            if (!selectedProfile) return;
            
            const confirmMsg = translations[currentLanguage].confirmDelete;
            if (!confirm(confirmMsg)) return;
            
            showLoading(true);
            const result = await deleteProfileAPI(selectedProfile.id);   // Fix: camelCase id
            showLoading(false);
            
            if (result.success) {   // Fix: backend returns { success: true }
                backToProfiles();
                selectedProfile = null;
                fetchProfiles();
            } else {
                showError(result.error || 'Failed to delete profile');   // Fix: .error not .message
            }
        }

        // ========================================
        // INITIALIZATION
        // ========================================
        window.onload = function() {
            // Check if API is configured
            if (API_URL === 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL') {
                showError('‚ö†Ô∏è Please configure API_URL in the script. See SETUP_GUIDE.md');
                return;
            }
            
            updateUIText();
            fetchProfiles();
        };
    </script>
</body>
</html>

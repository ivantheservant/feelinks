<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>åŒæ„Ÿ Feelinks</title>
  <style>
    :root {
      --primary: #5C6BC0;
      --primary-dark: #3F51B5;
      --accent: #FF7043;
      --success: #66BB6A;
      --warning: #FFA726;
      --danger: #EF5350;
      --bg: #F5F5F5;
      --card-bg: #FFFFFF;
      --text: #333333;
      --text-light: #666666;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans TC", "Microsoft JhengHei", sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    
    .header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      padding: 20px;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    
    .header h1 { font-size: 1.8em; margin-bottom: 5px; }
    .header p { opacity: 0.9; font-size: 0.9em; }
    
    .main-content { padding: 20px; max-width: 900px; margin: 0 auto; }
    
    .view { display: none; }
    .view.active { display: block; }
    
    .card {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .card h2 { color: var(--primary); margin-bottom: 15px; font-size: 1.3em; }
    .card h3 { color: var(--text); margin: 15px 0 10px; font-size: 1.1em; }
    
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--accent) 0%, #FF5722 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(255, 112, 67, 0.3);
    }
    
    .btn-primary:hover { transform: translateY(-2px); }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .btn-secondary { background: var(--primary); color: white; }
    .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
    .btn-danger { background: var(--danger); color: white; }
    .btn-success { background: var(--success); color: white; }
    .btn-small { padding: 8px 16px; font-size: 0.9em; }
    .btn-full { width: 100%; }
    .btn-group { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
    
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 6px; font-weight: 600; color: var(--text-light); }
    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #E0E0E0;
      border-radius: 10px;
      font-size: 1em;
      transition: border-color 0.2s;
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none;
      border-color: var(--primary);
    }
    .form-group textarea { min-height: 80px; resize: vertical; }
    .form-group .hint { font-size: 0.85em; color: var(--text-light); margin-top: 5px; }
    
    .checkbox-group { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: #F5F5F5;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .checkbox-item:hover { background: #E8E8E8; }
    .checkbox-item.selected { background: var(--primary); color: white; }
    .checkbox-item input { display: none; }
    
    .profile-card {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background: #F8F9FF;
      border-radius: 12px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .profile-card:hover { background: #EEF0FF; transform: translateX(5px); }
    .profile-card .info h4 { margin-bottom: 5px; color: var(--primary); }
    .profile-card .info p { font-size: 0.85em; color: var(--text-light); }
    .profile-card .meta { text-align: right; font-size: 0.85em; color: var(--text-light); }
    
    .question-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 20px;
      padding: 30px 25px;
      min-height: 180px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      margin-bottom: 20px;
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
      position: relative;
    }
    
    .question-card.empty {
      background: linear-gradient(135deg, #a8a8a8 0%, #888888 100%);
    }
    
    .question-number { position: absolute; top: 15px; right: 20px; font-size: 0.8em; opacity: 0.8; }
    .question-category { background: rgba(255,255,255,0.2); padding: 5px 15px; border-radius: 20px; font-size: 0.85em; margin-bottom: 15px; }
    .question-text { font-size: 1.35em; line-height: 1.5; font-weight: 500; }
    
    .stats { display: flex; justify-content: space-around; padding: 15px; background: #F0F4FF; border-radius: 12px; margin-bottom: 15px; }
    .stat-item { text-align: center; }
    .stat-value { font-size: 1.5em; font-weight: bold; color: var(--primary); }
    .stat-label { font-size: 0.8em; color: var(--text-light); }
    
    .category-select { width: 100%; padding: 12px 15px; border: 2px solid #E0E0E0; border-radius: 10px; font-size: 1em; background: white; margin-bottom: 15px; }
    
    .emotion-section { margin-bottom: 15px; }
    .emotion-title { font-weight: 600; margin-bottom: 8px; padding: 5px 10px; border-radius: 5px; display: inline-block; }
    .emotion-title.positive { background: #E8F5E9; color: #2E7D32; }
    .emotion-title.neutral { background: #FFF3E0; color: #E65100; }
    .emotion-title.challenging { background: #FFEBEE; color: #C62828; }
    .emotion-words { display: flex; flex-wrap: wrap; gap: 8px; }
    .emotion-word { background: #F5F5F5; padding: 6px 12px; border-radius: 20px; font-size: 0.85em; cursor: pointer; transition: all 0.2s; }
    .emotion-word:hover { background: #E0E0E0; }
    .emotion-word.selected { background: var(--primary); color: white; }
    
    .loading { text-align: center; padding: 40px; }
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #E0E0E0;
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .toast.show { opacity: 1; }
    .toast.success { background: var(--success); }
    .toast.error { background: var(--danger); }
    
    .nav-tabs {
      display: flex;
      background: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      overflow-x: auto;
      margin-bottom: 20px;
      border-radius: 12px;
    }
    .nav-tab {
      flex: 1;
      padding: 15px;
      text-align: center;
      border: none;
      background: none;
      font-size: 0.9em;
      color: var(--text-light);
      cursor: pointer;
      border-bottom: 3px solid transparent;
    }
    .nav-tab.active { color: var(--primary); border-bottom-color: var(--primary); font-weight: bold; }
    
    .rule-item { display: flex; gap: 10px; margin-bottom: 12px; }
    .rule-icon { font-size: 1.2em; min-width: 30px; text-align: center; }
    
    .special-rules { background: #FFF8E1; border-left: 4px solid var(--warning); padding: 15px; border-radius: 0 10px 10px 0; margin-top: 15px; }
    .special-rules h3 { color: #F57C00; margin-bottom: 10px; }
    
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
    }
    .modal-overlay.show { display: flex; align-items: center; justify-content: center; }
    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 20px;
      max-width: 400px;
      margin: 20px;
      text-align: center;
    }
    
    .history-item {
      background: #F5F5F5;
      padding: 12px 15px;
      border-radius: 10px;
      margin-bottom: 8px;
      border-left: 4px solid var(--primary);
    }
    .history-category {
      font-size: 0.75em;
      color: var(--text-light);
      margin-bottom: 5px;
    }
    .history-empty {
      text-align: center;
      color: var(--text-light);
      padding: 40px 20px;
    }
    
    .player-tag {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      background: var(--primary);
      color: white;
      padding: 5px 12px;
      border-radius: 20px;
      margin: 5px;
      font-size: 0.9em;
    }
    .player-tag button {
      background: none;
      border: none;
      color: white;
      font-size: 1.2em;
      cursor: pointer;
      padding: 0 5px;
      line-height: 1;
    }
    
    .turn-indicator {
      background: linear-gradient(135deg, #FFF3E0 0%, #FFECB3 100%);
      border-left: 4px solid var(--accent);
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 15px;
      display: none;
    }
    
    @keyframes animate-in {
      from { transform: scale(0.9); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    .animate-in { animation: animate-in 0.3s ease-out; }
    
    @media (max-width: 600px) {
      .header h1 { font-size: 1.5em; }
      .question-text { font-size: 1.2em; }
      .btn { padding: 10px 20px; font-size: 0.95em; }
    }
  </style>
</head>
<body>

<div class="header">
  <h1>ğŸ² åŒæ„Ÿ Feelinks</h1>
  <p>æƒ…ç·’é€£çµå¡ç‰ŒéŠæˆ²</p>
</div>

<div class="main-content">

<!-- ===== é¸æ“‡ Profile ===== -->
<div id="view-select-profile" class="view active">
  <div class="card">
    <h2>ğŸ—‚ï¸ é¸æ“‡éŠæˆ²å¡çµ„</h2>
    <div id="profile-list">
      <div class="loading">
        <div class="loading-spinner"></div>
        <p>è¼‰å…¥ä¸­...</p>
      </div>
    </div>
    <div class="btn-group">
      <button class="btn btn-outline btn-full" onclick="showView('create-profile')">
        â• å‰µå»ºæ–°å¡çµ„
      </button>
    </div>
  </div>
</div>

<!-- ===== å‰µå»º Profile ===== -->
<div id="view-create-profile" class="view">
  <div class="card">
    <h2>â• å‰µå»ºæ–°å¡çµ„</h2>
    
    <form id="form-create-profile">
      <div class="form-group">
        <label>å¡çµ„åç¨± *</label>
        <input type="text" id="profile-name" required placeholder="ä¾‹å¦‚ï¼šæˆ‘å€‘å®¶çš„å•é¡Œå¡">
      </div>
      
      <div class="form-group">
        <label>é¡å‹</label>
        <input type="text" id="profile-type" placeholder="ä¾‹å¦‚ï¼šå®¶åº­ã€å°çµ„ã€æœ‹å‹">
      </div>
      
      <div class="form-group">
        <label>æè¿°</label>
        <textarea id="profile-description" placeholder="ç°¡å–®æè¿°é€™å‰¯å¡çµ„çš„ç”¨é€”"></textarea>
      </div>
      
      <h3>ğŸ“‹ é¸æ“‡é€šç”¨å•é¡Œ</h3>
      <p class="form-group hint">å¾å•é¡Œåº«ä¸­é¸æ“‡é©åˆçš„åˆ†é¡</p>
      <div id="general-categories" class="checkbox-group">
        <div class="loading">
          <div class="loading-spinner"></div>
          <p>è¼‰å…¥åˆ†é¡ä¸­...</p>
        </div>
      </div>
      
      <h3>ğŸ¤– AI ç”Ÿæˆå•é¡Œï¼ˆé¸å¡«ï¼‰</h3>
      <div class="form-group">
        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
          <input type="checkbox" id="enable-ai" onchange="toggleAISection()">
          å•Ÿç”¨ AI ç”Ÿæˆ
        </label>
      </div>
      
      <div id="ai-section" style="display: none;">
        <div class="form-group">
          <label>å°çµ„é¡å‹</label>
          <input type="text" id="ai-group-type" placeholder="ä¾‹å¦‚ï¼šé’å¹´åœ˜å¥‘ã€å¤«å©¦å°çµ„">
        </div>
        
        <div class="form-group">
          <label>åƒèˆ‡è€…èƒŒæ™¯</label>
          <input type="text" id="ai-audience" placeholder="ä¾‹å¦‚ï¼š18-25æ­²å¤§å­¸ç”Ÿ">
        </div>
        
        <div class="form-group">
          <label>ä¸»é¡Œ/ç›®çš„</label>
          <input type="text" id="ai-theme" placeholder="ä¾‹å¦‚ï¼šé¢å°å£“åŠ›ã€å¢é€²å½¼æ­¤äº†è§£">
        </div>
        
        <div class="form-group">
          <label>è‡ªè¨‚åˆ†é¡ï¼ˆé¸å¡«ï¼‰</label>
          <input type="text" id="ai-categories" placeholder="ä¾‹å¦‚ï¼šå­¸æ¥­å£“åŠ›, äººéš›é—œä¿‚, ä¿¡ä»°æ™æ‰">
          <div class="hint">ç”¨é€—è™Ÿåˆ†éš”å¤šå€‹åˆ†é¡</div>
        </div>
        
        <div class="form-group">
          <label>ç”Ÿæˆæ•¸é‡</label>
          <input type="number" id="ai-count" value="20" min="5" max="50">
        </div>
      </div>
      
      <div class="btn-group">
        <button type="button" class="btn btn-outline" onclick="showView('select-profile')">å–æ¶ˆ</button>
        <button type="submit" class="btn btn-primary" id="btn-create-submit">å‰µå»ºå¡çµ„</button>
      </div>
    </form>
  </div>
</div>

<!-- ===== éŠæˆ²ä¸»ç•Œé¢ ===== -->
<div id="view-game" class="view">
  <div class="card">
    <div class="nav-tabs">
      <button class="nav-tab active" data-tab="play">ğŸ² æŠ½é¡Œ</button>
      <button class="nav-tab" data-tab="emotions">ğŸ’­ æƒ…ç·’è©</button>
      <button class="nav-tab" data-tab="rules">ğŸ“– è¦å‰‡</button>
      <button class="nav-tab" data-tab="history">ğŸ“‹ è¨˜éŒ„</button>
    </div>
    
    <!-- Tab: æŠ½é¡Œ -->
    <div id="tab-play" class="game-tab">
      <div class="stats">
        <div class="stat-item">
          <div class="stat-value" id="stat-total">0</div>
          <div class="stat-label">ç¸½é¡Œæ•¸</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="stat-categories">0</div>
          <div class="stat-label">åˆ†é¡</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="stat-drawn">0</div>
          <div class="stat-label">å·²æŠ½</div>
        </div>
      </div>
      
      <select id="category-select" class="category-select">
        <option value="all">ğŸ² å…¨éƒ¨éš¨æ©Ÿ</option>
      </select>
      
      <div id="question-card" class="question-card empty">
        <div class="question-text">é»æ“Šä¸‹æ–¹æŒ‰éˆ•æŠ½é¡Œ</div>
      </div>
      
      <div id="turn-indicator" class="turn-indicator">
        <div style="font-size: 0.9em; color: var(--text-light); margin-bottom: 5px;">ç•¶å‰å›åˆ</div>
        <div style="font-size: 1.3em; font-weight: bold; color: var(--accent);" id="current-player"></div>
      </div>
      
      <div class="btn-group" style="justify-content: center;">
        <button id="btn-draw" class="btn btn-primary">ğŸ² æŠ½ä¸€é¡Œ</button>
        <button id="btn-pass" class="btn btn-secondary" disabled>â­ï¸ æ›é¡Œ</button>
        <button id="btn-next-turn" class="btn btn-outline" style="display: none;">â¡ï¸ ä¸‹ä¸€ä½</button>
        <button id="btn-safe" class="btn btn-danger btn-small">ğŸ›‘ å®‰å…¨è©</button>
      </div>
      
      <div style="margin-top: 20px;">
        <h3>ğŸ‘¥ ç©å®¶</h3>
        <div style="display: flex; gap: 8px; margin-top: 10px;">
          <input type="text" id="player-name" placeholder="è¼¸å…¥ç©å®¶åç¨±" style="flex: 1; padding: 10px; border: 2px solid #E0E0E0; border-radius: 8px;">
          <button id="btn-add-player" class="btn btn-primary">åŠ å…¥</button>
        </div>
        <div id="player-list" style="margin-top: 10px;"></div>
      </div>
    </div>
    
    <!-- Tab: æƒ…ç·’è© -->
    <div id="tab-emotions" class="game-tab" style="display: none;">
      <p style="margin-bottom: 20px; color: var(--text-light);">é»æ“Šé¸æ“‡ä½ çš„æƒ…ç·’</p>
      
      <div class="emotion-section">
        <div class="emotion-title positive">ğŸŸ¢ æ­£é¢æƒ…ç·’</div>
        <div class="emotion-words" id="emotions-positive"></div>
      </div>
      
      <div class="emotion-section">
        <div class="emotion-title neutral">ğŸŸ¡ ä¸­æ€§æƒ…ç·’</div>
        <div class="emotion-words" id="emotions-neutral"></div>
      </div>
      
      <div class="emotion-section">
        <div class="emotion-title challenging">ğŸ”´ æŒ‘æˆ°æ€§æƒ…ç·’</div>
        <div class="emotion-words" id="emotions-challenging"></div>
      </div>
    </div>
    
    <!-- Tab: è¦å‰‡ -->
    <div id="tab-rules" class="game-tab" style="display: none;">
      <h3>ğŸ¯ åŸºæœ¬æµç¨‹</h3>
      <div class="rule-item">
        <div class="rule-icon">1ï¸âƒ£</div>
        <div>æŠ½ä¸€å¼µå•é¡Œå¡</div>
      </div>
      <div class="rule-item">
        <div class="rule-icon">2ï¸âƒ£</div>
        <div>æ¯å€‹äººé¸æ“‡ä¸€å€‹æƒ…ç·’è©</div>
      </div>
      <div class="rule-item">
        <div class="rule-icon">3ï¸âƒ£</div>
        <div>è¼ªæµåˆ†äº«ï¼šæˆ‘é¸é€™å€‹è©æ˜¯å› ç‚º...</div>
      </div>
      
      <div class="special-rules">
        <h3>ğŸ›‘ å®‰å…¨è©</h3>
        <p>ä»»ä½•æ™‚å€™ï¼Œä»»ä½•äººéƒ½å¯ä»¥èªªã€Œå®‰å…¨è©ã€æš«åœéŠæˆ²ã€‚</p>
        <p style="margin-top: 8px;">ä½¿ç”¨æ™‚æ©Ÿï¼š</p>
        <ul style="margin-left: 20px; margin-top: 5px;">
          <li>è¦ºå¾—ä¸èˆ’æœ</li>
          <li>éœ€è¦ä¼‘æ¯</li>
          <li>æƒ³è·³éæŸé¡Œ</li>
        </ul>
      </div>
      
      <h3 style="margin-top: 20px;">ğŸ’¡ éŠæˆ²åŸå‰‡</h3>
      <div class="rule-item">
        <div class="rule-icon">âœ…</div>
        <div>æ²’æœ‰å°éŒ¯ï¼Œåªæœ‰æ„Ÿå—</div>
      </div>
      <div class="rule-item">
        <div class="rule-icon">âœ…</div>
        <div>å°Šé‡æ¯å€‹äººçš„åˆ†äº«</div>
      </div>
      <div class="rule-item">
        <div class="rule-icon">âœ…</div>
        <div>å¯ä»¥é¸æ“‡ä¸å›ç­”</div>
      </div>
      <div class="rule-item">
        <div class="rule-icon">âœ…</div>
        <div>ä¿è­·éš±ç§ï¼Œä¸å¤–å‚³</div>
      </div>
    </div>
    
    <!-- Tab: è¨˜éŒ„ -->
    <div id="tab-history" class="game-tab" style="display: none;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h3>å·²æŠ½å•é¡Œ</h3>
        <button id="btn-clear-history" class="btn btn-small btn-outline">æ¸…é™¤è¨˜éŒ„</button>
      </div>
      <div id="history-list">
        <div class="history-empty">é‚„æ²’æœ‰æŠ½éå•é¡Œ</div>
      </div>
    </div>
    
    <div class="btn-group" style="margin-top: 20px;">
      <button class="btn btn-outline" onclick="showView('select-profile')">â† è¿”å›</button>
      <button id="btn-reset" class="btn btn-danger">ğŸ”„ é‡æ–°é–‹å§‹</button>
    </div>
  </div>
</div>

</div>

<!-- ===== Toast ===== -->
<div id="toast" class="toast"></div>

<!-- ===== å®‰å…¨è© Modal ===== -->
<div id="modal-safe" class="modal-overlay">
  <div class="modal-content">
    <div style="font-size: 3em; margin-bottom: 15px;">ğŸ›‘</div>
    <h2>å®‰å…¨è©</h2>
    <p style="color: var(--text-light); margin-bottom: 20px;">éŠæˆ²æš«åœã€‚å¤§å®¶æ·±å‘¼å¸,ä¼‘æ¯ä¸€ä¸‹ã€‚</p>
    <div class="btn-group" style="justify-content: center;">
      <button class="btn btn-secondary" onclick="safeWordSkip()">â­ï¸ æ›ä¸€é¡Œ</button>
      <button class="btn btn-outline" onclick="closeSafeWord()">âœ“ ç¹¼çºŒ</button>
    </div>
  </div>
</div>

<script>
// =============================================
// FEELINKS AI - å‰ç«¯ JavaScript
// =============================================

// ===== é…ç½® =====
// ğŸ”§ éƒ¨ç½² Google Apps Script å¾Œï¼Œå°‡ URL å¡«å…¥é€™è£¡
const API_URL = 'https://script.google.com/macros/s/AKfycbzP6lD_L7dU3df2JJ78cP4nAamnawAyxaoIR-PxOToBZncf4-FHicmY2zXXZEwW2GpM/exec';

// ===== æƒ…ç·’è© =====
const EMOTIONS = {
  positive: ["é–‹å¿ƒ","èˆˆå¥®","å¹³éœ","å¥½å¥‡","æ„Ÿæ©","æº«æš–","å®‰å¿ƒ","æ»¿è¶³","è¢«æ„›","è‡ªåœ¨","é©•å‚²","å¸Œæœ›","è¼•é¬†","å¹¸ç¦","æœŸå¾…"],
  neutral: ["ç„¡æ‰€è¬‚","å¹³æ·¡","çŒ¶è±«","è¤‡é›œ","è‹¥æœ‰æ‰€æ€","çŸ›ç›¾"],
  challenging: ["ç·Šå¼µ","æ“”å¿ƒ","ç…©èº","å°·å°¬","ç„¡èŠ","å›°æƒ‘","å‚·å¿ƒ","å®³æ€•","ç–²å€¦","å¤±æœ›","å­¤å–®","ä¸çŸ¥æ‰€æª","ç„¦æ…®","æŒ«æ•—"]
};

// ===== ç‹€æ…‹ =====
let state = {
  currentProfile: null,
  questions: {},
  drawnCount: 0,
  history: [],
  players: [],
  currentPlayerIndex: 0
};

// ===== é é¢å°èˆª =====
function showView(viewId) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.getElementById('view-' + viewId).classList.add('active');
  
  if (viewId === 'create-profile') {
    loadGeneralCategories();
  }
}

// ===== API èª¿ç”¨ =====
async function apiCall(action, data = {}) {
  const payload = { action, ...data };
  
  try {
    const response = await fetch(API_URL, {
      method: 'POST',
      body: JSON.stringify(payload),
      headers: { 'Content-Type': 'application/json' }
    });
    
    return await response.json();
  } catch (error) {
    return { success: false, error: error.toString() };
  }
}

// ===== Profile ç®¡ç† =====
async function loadProfiles() {
  const result = await apiCall('listProfiles');
  
  const list = document.getElementById('profile-list');
  
  if (!result.success || result.profiles.length === 0) {
    list.innerHTML = '<p style="text-align: center; color: var(--text-light); padding: 40px;">é‚„æ²’æœ‰ä»»ä½•å¡çµ„</p>';
    return;
  }
  
  list.innerHTML = result.profiles.map(p => `
    <div class="profile-card" onclick="selectProfile('${p.id}')">
      <div class="info">
        <h4>${p.name}</h4>
        <p>${p.description || p.type || 'æœªå¡«å¯«'}</p>
      </div>
      <div class="meta">
        <div>${p.questionCount} é¡Œ</div>
        <div>${p.language || 'ç¹é«”ä¸­æ–‡'}</div>
      </div>
    </div>
  `).join('');
}

async function selectProfile(profileId) {
  showToast('è¼‰å…¥ä¸­...', '');
  
  const result = await apiCall('getProfile', { profileId });
  
  if (!result.success) {
    showToast('è¼‰å…¥å¤±æ•—: ' + result.error, 'error');
    return;
  }
  
  state.currentProfile = result.profile;
  state.questions = result.questions;
  state.drawnCount = 0;
  state.history = [];
  
  showView('game');
  initGame();
  showToast('è¼‰å…¥æˆåŠŸï¼', 'success');
}

async function loadGeneralCategories() {
  const result = await apiCall('getGeneralCategories');
  
  const container = document.getElementById('general-categories');
  
  if (!result.success || !result.categories) {
    container.innerHTML = '<p style="color: var(--text-light);">ç„¡æ³•è¼‰å…¥åˆ†é¡</p>';
    return;
  }
  
  container.innerHTML = result.categories.map(cat => `
    <label class="checkbox-item">
      <input type="checkbox" name="general-cat" value="${cat.name}">
      <span>${cat.name} (${cat.count}é¡Œ)</span>
    </label>
  `).join('');
  
  // é»æ“Šäº‹ä»¶
  container.querySelectorAll('.checkbox-item').forEach(item => {
    item.addEventListener('click', function() {
      this.classList.toggle('selected');
      this.querySelector('input').checked = this.classList.contains('selected');
    });
  });
}

document.getElementById('form-create-profile').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const submitBtn = document.getElementById('btn-create-submit');
  submitBtn.disabled = true;
  submitBtn.textContent = 'å‰µå»ºä¸­...';
  
  const selectedCategories = Array.from(document.querySelectorAll('input[name="general-cat"]:checked'))
    .map(cb => cb.value);
  
  const data = {
    name: document.getElementById('profile-name').value,
    type: document.getElementById('profile-type').value,
    description: document.getElementById('profile-description').value,
    includeGeneralCategories: selectedCategories,
    generateAI: document.getElementById('enable-ai').checked
  };
  
  if (data.generateAI) {
    data.aiSettings = {
      language: 'ç¹é«”ä¸­æ–‡',
      groupType: document.getElementById('ai-group-type').value,
      audience: document.getElementById('ai-audience').value,
      theme: document.getElementById('ai-theme').value,
      categories: document.getElementById('ai-categories').value,
      questionCount: parseInt(document.getElementById('ai-count').value)
    };
  }
  
  const result = await apiCall('createProfile', data);
  
  submitBtn.disabled = false;
  submitBtn.textContent = 'å‰µå»ºå¡çµ„';
  
  if (result.success) {
    showToast(`å‰µå»ºæˆåŠŸï¼å…± ${result.questionCount} é¡Œ`, 'success');
    showView('select-profile');
    loadProfiles();
  } else {
    showToast('å‰µå»ºå¤±æ•—: ' + result.error, 'error');
  }
});

function toggleAISection() {
  const section = document.getElementById('ai-section');
  section.style.display = document.getElementById('enable-ai').checked ? 'block' : 'none';
}

// ===== éŠæˆ²é‚è¼¯ =====
function initGame() {
  populateCategories();
  populateEmotions();
  updateStats();
  updateHistory();
  updatePlayerList();
  updateTurnIndicator();
  
  document.getElementById('question-card').classList.add('empty');
  document.getElementById('question-card').innerHTML = '<div class="question-text">é»æ“Šä¸‹æ–¹æŒ‰éˆ•æŠ½é¡Œ</div>';
  document.getElementById('btn-pass').disabled = true;
}

function populateCategories() {
  const select = document.getElementById('category-select');
  const total = getAllQuestions().length;
  select.innerHTML = `<option value="all">ğŸ² å…¨éƒ¨éš¨æ©Ÿ (${total}é¡Œ)</option>`;
  
  for (const [cat, qs] of Object.entries(state.questions)) {
    select.innerHTML += `<option value="${cat}">${cat} (${qs.length}é¡Œ)</option>`;
  }
}

function populateEmotions() {
  ['positive', 'neutral', 'challenging'].forEach(type => {
    document.getElementById('emotions-' + type).innerHTML = 
      EMOTIONS[type].map(e => `<span class="emotion-word" onclick="this.classList.toggle('selected')">${e}</span>`).join('');
  });
}

function getAllQuestions() {
  let all = [];
  for (const [cat, qs] of Object.entries(state.questions)) {
    qs.forEach(q => all.push({ ...q, category: cat }));
  }
  return all;
}

function getRandomQuestion(category = 'all') {
  let pool = category === 'all' 
    ? getAllQuestions() 
    : (state.questions[category] || []).map(q => ({ ...q, category }));
  
  const drawn = state.history.map(h => h.tc);
  pool = pool.filter(q => !drawn.includes(q.tc));
  
  return pool.length ? pool[Math.floor(Math.random() * pool.length)] : null;
}

function updateStats() {
  document.getElementById('stat-total').textContent = getAllQuestions().length;
  document.getElementById('stat-categories').textContent = Object.keys(state.questions).length;
  document.getElementById('stat-drawn').textContent = state.drawnCount;
}

function drawQuestion() {
  const category = document.getElementById('category-select').value;
  const q = getRandomQuestion(category);
  
  const card = document.getElementById('question-card');
  
  if (!q) {
    card.classList.add('empty');
    card.innerHTML = '<div class="question-text">å·²æŠ½å®Œæ‰€æœ‰å•é¡Œï¼ğŸ‰</div>';
    document.getElementById('btn-pass').disabled = true;
    return;
  }
  
  state.drawnCount++;
  state.history.push(q);
  
  card.classList.remove('empty');
  card.classList.add('animate-in');
  card.innerHTML = `
    <div class="question-number">#${state.drawnCount}</div>
    <div class="question-category">${q.category}</div>
    <div class="question-text">${q.tc}</div>
  `;
  
  setTimeout(() => card.classList.remove('animate-in'), 300);
  
  updateStats();
  updateHistory();
  document.getElementById('btn-pass').disabled = false;
  
  if (navigator.vibrate) navigator.vibrate(50);
}

function passQuestion() {
  drawQuestion();
}

function nextTurn() {
  if (state.players.length > 0) {
    state.currentPlayerIndex = (state.currentPlayerIndex + 1) % state.players.length;
    updateTurnIndicator();
    updatePlayerList();
  }
}

function addPlayer() {
  const input = document.getElementById('player-name');
  const name = input.value.trim();
  if (name && state.players.length < 20) {
    state.players.push(name);
    input.value = '';
    updatePlayerList();
    updateTurnIndicator();
  }
}

function removePlayer(index) {
  state.players.splice(index, 1);
  if (state.currentPlayerIndex >= state.players.length) state.currentPlayerIndex = 0;
  updatePlayerList();
  updateTurnIndicator();
}

function updatePlayerList() {
  document.getElementById('player-list').innerHTML = state.players.map((p, i) => 
    `<span class="player-tag">${p}<button onclick="removePlayer(${i})">&times;</button></span>`
  ).join('');
}

function updateTurnIndicator() {
  const indicator = document.getElementById('turn-indicator');
  const btn = document.getElementById('btn-next-turn');
  if (state.players.length > 0) {
    indicator.style.display = 'block';
    document.getElementById('current-player').textContent = state.players[state.currentPlayerIndex];
    btn.style.display = 'inline-flex';
  } else {
    indicator.style.display = 'none';
    btn.style.display = 'none';
  }
}

function updateHistory() {
  const list = document.getElementById('history-list');
  if (!state.history.length) {
    list.innerHTML = '<div class="history-empty">é‚„æ²’æœ‰æŠ½éå•é¡Œ</div>';
    return;
  }
  list.innerHTML = state.history.slice().reverse().map(q => 
    `<div class="history-item"><div class="history-category">${q.category}</div><div>${q.tc}</div></div>`
  ).join('');
}

function clearHistory() {
  if (confirm('ç¢ºå®šè¦æ¸…é™¤è¨˜éŒ„å—ï¼Ÿ')) {
    state.history = [];
    state.drawnCount = 0;
    updateHistory();
    updateStats();
  }
}

function resetGame() {
  if (confirm('ç¢ºå®šè¦é‡æ–°é–‹å§‹å—ï¼Ÿ')) {
    state.drawnCount = 0;
    state.history = [];
    state.players = [];
    state.currentPlayerIndex = 0;
    initGame();
  }
}

function showSafeWord() {
  document.getElementById('modal-safe').classList.add('show');
  if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
}

function closeSafeWord() {
  document.getElementById('modal-safe').classList.remove('show');
}

function safeWordSkip() {
  closeSafeWord();
  drawQuestion();
}

// ===== Tab åˆ‡æ› =====
document.querySelectorAll('.nav-tab').forEach(tab => {
  tab.addEventListener('click', function() {
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.game-tab').forEach(t => t.style.display = 'none');
    
    this.classList.add('active');
    document.getElementById('tab-' + this.dataset.tab).style.display = 'block';
  });
});

// ===== Toast =====
function showToast(message, type = '') {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.className = 'toast show ' + type;
  setTimeout(() => toast.classList.remove('show'), 3000);
}

// ===== äº‹ä»¶ç¶å®š =====
document.getElementById('btn-draw').addEventListener('click', drawQuestion);
document.getElementById('btn-pass').addEventListener('click', passQuestion);
document.getElementById('btn-next-turn').addEventListener('click', nextTurn);
document.getElementById('btn-add-player').addEventListener('click', addPlayer);
document.getElementById('player-name').addEventListener('keypress', e => { if (e.key === 'Enter') addPlayer(); });
document.getElementById('btn-safe').addEventListener('click', showSafeWord);
document.getElementById('btn-clear-history').addEventListener('click', clearHistory);
document.getElementById('btn-reset').addEventListener('click', resetGame);
document.getElementById('modal-safe').addEventListener('click', e => { if (e.target === e.currentTarget) closeSafeWord(); });

// ===== åˆå§‹åŒ– =====
document.addEventListener('DOMContentLoaded', () => {
  // æª¢æŸ¥ API URL æ˜¯å¦å·²è¨­ç½®
  if (API_URL === 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL') {
    document.getElementById('profile-list').innerHTML = `
      <div style="background: #FFF3E0; padding: 20px; border-radius: 10px; border-left: 4px solid var(--warning);">
        <h3 style="color: #E65100; margin-bottom: 10px;">âš ï¸ éœ€è¦è¨­ç½® API</h3>
        <p>è«‹å…ˆå®Œæˆ Google Apps Script éƒ¨ç½²ï¼Œç„¶å¾Œå°‡ Web App URL å¡«å…¥æ­¤æª”æ¡ˆçš„ <code>API_URL</code> è®Šé‡ã€‚</p>
        <p style="margin-top: 10px;"><a href="#" style="color: var(--primary);">æŸ¥çœ‹è¨­ç½®èªªæ˜ â†’</a></p>
      </div>
    `;
  } else {
    loadProfiles();
  }
});
</script>

</body>
</html>

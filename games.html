<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>ğŸ¯ åœ˜å»ºéŠæˆ²ç”Ÿæˆå™¨ Game Generator</title>
  <style>
    :root {
      --primary: #E64A19;
      --primary-dark: #BF360C;
      --primary-light: #FF8A65;
      --accent: #FF6D00;
      --success: #43A047;
      --warning: #FFA000;
      --danger: #D32F2F;
      --bg: #FFF8F0;
      --card-bg: #FFFFFF;
      --text: #3E2723;
      --text-light: #795548;
      --text-muted: #A1887F;
      --border: #FFCCBC;
      --step-inactive: #D7CCC8;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans TC", "Microsoft JhengHei", sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* ===== Header ===== */
    .header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      padding: 20px;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 12px rgba(230, 74, 25, 0.3);
    }
    .header h1 { font-size: 1.6em; margin-bottom: 4px; }
    .header p { opacity: 0.9; font-size: 0.85em; }
    .header-nav { display: flex; justify-content: center; gap: 15px; margin-top: 12px; }
    .header-nav a {
      color: rgba(255,255,255,0.85);
      text-decoration: none;
      font-size: 0.85em;
      padding: 5px 12px;
      border-radius: 20px;
      transition: all 0.2s;
    }
    .header-nav a:hover, .header-nav a.active {
      background: rgba(255,255,255,0.2);
      color: white;
    }

    .main-content { padding: 20px; max-width: 800px; margin: 0 auto; }

    /* ===== Views ===== */
    .view { display: none; }
    .view.active { display: block; }

    /* ===== Cards ===== */
    .card {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 2px 12px rgba(62, 39, 35, 0.06);
      border: 1px solid rgba(255, 204, 188, 0.3);
    }
    .card h2 { color: var(--primary); margin-bottom: 15px; font-size: 1.25em; }
    .card h3 { color: var(--text); margin: 18px 0 10px; font-size: 1.05em; }

    /* ===== Step Progress Bar ===== */
    .step-progress {
      display: flex;
      justify-content: space-between;
      margin-bottom: 25px;
      position: relative;
    }
    .step-progress::before {
      content: '';
      position: absolute;
      top: 16px;
      left: 30px;
      right: 30px;
      height: 3px;
      background: var(--step-inactive);
      z-index: 0;
    }
    .step-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      z-index: 1;
      cursor: pointer;
    }
    .step-circle {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      background: var(--step-inactive);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.85em;
      transition: all 0.3s;
      margin-bottom: 6px;
    }
    .step-item.active .step-circle { background: var(--primary); transform: scale(1.1); box-shadow: 0 3px 10px rgba(230, 74, 25, 0.3); }
    .step-item.done .step-circle { background: var(--success); }
    .step-label { font-size: 0.7em; color: var(--text-muted); text-align: center; max-width: 70px; }
    .step-item.active .step-label { color: var(--primary); font-weight: 600; }

    /* ===== Forms ===== */
    .form-group { margin-bottom: 18px; }
    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      color: var(--text-light);
      font-size: 0.92em;
    }
    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid var(--border);
      border-radius: 10px;
      font-size: 1em;
      transition: border-color 0.2s;
      background: white;
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none;
      border-color: var(--primary);
    }
    .form-group textarea { min-height: 80px; resize: vertical; }
    .form-group .hint { font-size: 0.82em; color: var(--text-muted); margin-top: 5px; }

    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 500px) { .form-row { grid-template-columns: 1fr; } }

    /* ===== Checkbox Chips ===== */
    .chip-group { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
    .chip {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 14px;
      background: #FBE9E7;
      border: 2px solid transparent;
      border-radius: 25px;
      cursor: pointer;
      transition: all 0.2s;
      user-select: none;
      font-size: 0.9em;
    }
    .chip:hover { border-color: var(--primary-light); }
    .chip.selected { background: #FFCCBC; border-color: var(--primary); color: var(--primary-dark); font-weight: 600; }
    .chip input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--primary);
      cursor: pointer;
      flex-shrink: 0;
      pointer-events: none;
    }

    /* ===== Radio Chips ===== */
    .radio-group { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
    .radio-chip {
      padding: 10px 18px 10px 14px;
      background: #FBE9E7;
      border: 2px solid transparent;
      border-radius: 25px;
      cursor: pointer;
      transition: all 0.2s;
      user-select: none;
      font-size: 0.9em;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .radio-chip::before {
      content: '';
      width: 18px;
      height: 18px;
      border: 2px solid #BCAAA4;
      border-radius: 50%;
      flex-shrink: 0;
      transition: all 0.2s;
      background: white;
    }
    .radio-chip:hover { border-color: var(--primary-light); }
    .radio-chip:hover::before { border-color: var(--primary-light); }
    .radio-chip.selected { background: var(--primary); color: white; border-color: var(--primary); font-weight: 600; }
    .radio-chip.selected::before {
      border-color: white;
      background: white;
      box-shadow: inset 0 0 0 4px var(--primary);
    }

    /* ===== Buttons ===== */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(230, 74, 25, 0.3);
    }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(230, 74, 25, 0.4); }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .btn-secondary { background: var(--text-light); color: white; }
    .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
    .btn-outline:hover { background: #FBE9E7; }
    .btn-success { background: var(--success); color: white; }
    .btn-small { padding: 8px 16px; font-size: 0.9em; }
    .btn-full { width: 100%; }
    .btn-group { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 20px; }

    /* ===== Step Navigation ===== */
    .step-nav { display: flex; justify-content: space-between; margin-top: 25px; }

    /* ===== Conditional Section ===== */
    .conditional { display: none; margin-top: 12px; padding: 15px; background: #FFF3E0; border-radius: 10px; border-left: 4px solid var(--warning); }
    .conditional.show { display: block; }

    /* ===== Loading ===== */
    .loading { text-align: center; padding: 50px 20px; }
    .loading-spinner {
      width: 50px; height: 50px;
      border: 5px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-text { color: var(--text-light); font-size: 1.05em; }
    .loading-sub { color: var(--text-muted); font-size: 0.85em; margin-top: 8px; }

    /* ===== Result Display ===== */
    .result-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
      padding: 15px;
      background: #FFF3E0;
      border-radius: 12px;
    }
    .result-content {
      background: white;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 25px;
      line-height: 1.8;
      font-size: 0.95em;
    }
    .result-content h1 { color: var(--primary-dark); margin: 25px 0 12px; font-size: 1.5em; border-bottom: 2px solid var(--border); padding-bottom: 8px; }
    .result-content h2 { color: var(--primary); margin: 20px 0 10px; font-size: 1.25em; }
    .result-content h3 { color: var(--text); margin: 15px 0 8px; font-size: 1.05em; }
    .result-content table { border-collapse: collapse; width: 100%; margin: 12px 0; }
    .result-content th, .result-content td { border: 1px solid var(--border); padding: 8px 12px; text-align: left; }
    .result-content th { background: #FBE9E7; color: var(--primary-dark); font-weight: 600; }
    .result-content hr { border: none; border-top: 2px solid var(--border); margin: 25px 0; }
    .result-content ol, .result-content ul { padding-left: 22px; margin: 8px 0; }
    .result-content li { margin-bottom: 5px; }
    .result-content blockquote { border-left: 4px solid var(--primary-light); padding: 10px 15px; margin: 10px 0; background: #FFF8F0; }

    /* ===== Markdown Raw View ===== */
    .markdown-raw {
      background: #263238;
      color: #ECEFF1;
      border-radius: 10px;
      padding: 20px;
      font-family: "SFMono-Regular", "Consolas", "Liberation Mono", monospace;
      font-size: 0.85em;
      line-height: 1.6;
      white-space: pre-wrap;
      word-wrap: break-word;
      max-height: 500px;
      overflow-y: auto;
    }

    /* ===== History List ===== */
    .history-card {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background: #FFF3E0;
      border-radius: 12px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid transparent;
    }
    .history-card:hover { background: #FFE0B2; border-color: var(--primary-light); transform: translateX(4px); }
    .history-card .info h4 { color: var(--primary-dark); margin-bottom: 4px; }
    .history-card .info p { font-size: 0.82em; color: var(--text-muted); }
    .history-card .meta { text-align: right; font-size: 0.82em; color: var(--text-muted); }

    /* ===== Toast ===== */
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s;
      max-width: 90%;
    }
    .toast.show { opacity: 1; }
    .toast.success { background: var(--success); }
    .toast.error { background: var(--danger); }

    /* ===== Toggle Switch ===== */
    .toggle-row { display: flex; align-items: center; gap: 12px; margin: 8px 0; }
    .toggle-label { font-weight: 500; }
    .toggle {
      position: relative;
      width: 50px;
      height: 26px;
      background: #D7CCC8;
      border-radius: 13px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .toggle.on { background: var(--primary); }
    .toggle::after {
      content: '';
      position: absolute;
      top: 3px;
      left: 3px;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      transition: transform 0.3s;
    }
    .toggle.on::after { transform: translateX(24px); }

    /* ===== View Toggle for Results ===== */
    .view-toggle {
      display: flex;
      background: #FBE9E7;
      border-radius: 8px;
      overflow: hidden;
    }
    .view-toggle-btn {
      padding: 8px 16px;
      border: none;
      background: none;
      cursor: pointer;
      font-size: 0.85em;
      font-weight: 500;
      color: var(--text-light);
      transition: all 0.2s;
    }
    .view-toggle-btn.active { background: var(--primary); color: white; }

    /* ===== Email Modal ===== */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .modal-overlay.show { display: flex; }
    .modal {
      background: white;
      border-radius: 16px;
      padding: 25px;
      max-width: 420px;
      width: 100%;
      box-shadow: 0 15px 40px rgba(0,0,0,0.2);
    }
    .modal h3 { color: var(--primary); margin-bottom: 15px; }
  </style>
</head>
<body>

<!-- ===== HEADER ===== -->
<div class="header">
  <h1>ğŸ¯ åœ˜å»ºéŠæˆ²ç”Ÿæˆå™¨</h1>
  <p>Team Building Game Generator</p>
  <div class="header-nav">
    <a href="#" class="active" onclick="showView('create')">âœ¨ æ–°å»º</a>
    <a href="#" onclick="showView('history')">ğŸ“‹ æ­·å²è¨˜éŒ„</a>
    <a href="index.html" style="opacity:0.7">â† è¿”å› Feelinks</a>
  </div>
</div>

<div class="main-content">

  <!-- ===================================================== -->
  <!-- CREATE VIEW - Step Wizard -->
  <!-- ===================================================== -->
  <div class="view active" id="view-create">

    <!-- Step Progress -->
    <div class="step-progress" id="step-progress">
      <div class="step-item active" data-step="1" onclick="goToStep(1)">
        <div class="step-circle">1</div>
        <div class="step-label">åƒåŠ è€…</div>
      </div>
      <div class="step-item" data-step="2" onclick="goToStep(2)">
        <div class="step-circle">2</div>
        <div class="step-label">æ´»å‹•è¨­å®š</div>
      </div>
      <div class="step-item" data-step="3" onclick="goToStep(3)">
        <div class="step-circle">3</div>
        <div class="step-label">ç‰¹åˆ¥è¦æ±‚</div>
      </div>
      <div class="step-item" data-step="4" onclick="goToStep(4)">
        <div class="step-circle">4</div>
        <div class="step-label">ç›®çš„</div>
      </div>
      <div class="step-item" data-step="5" onclick="goToStep(5)">
        <div class="step-circle">5</div>
        <div class="step-label">ç¢ºèª</div>
      </div>
    </div>

    <!-- STEP 1: Participants -->
    <div class="step-content" id="step-1">
      <div class="card">
        <h2>ğŸ‘¥ åƒåŠ è€…è³‡æ–™ Participants</h2>

        <div class="form-row">
          <div class="form-group">
            <label>å¹´é½¡ç¯„åœ Age Range</label>
            <input type="text" id="f-ageRange" placeholder="ä¾‹å¦‚ï¼š45-55" value="">
          </div>
          <div class="form-group">
            <label>é è¨ˆäººæ•¸ Headcount</label>
            <input type="text" id="f-participantCount" placeholder="ä¾‹å¦‚ï¼š20-30" value="">
          </div>
        </div>

        <div class="form-group">
          <label>åƒåŠ è€…é—œä¿‚ Relationship</label>
          <div class="radio-group" id="rg-relationship">
            <div class="radio-chip" data-value="å¤«å©¦" onclick="selectRadio(this)">ğŸ’‘ å¤«å©¦</div>
            <div class="radio-chip" data-value="æœ‹å‹" onclick="selectRadio(this)">ğŸ¤ æœ‹å‹</div>
            <div class="radio-chip" data-value="åŒäº‹" onclick="selectRadio(this)">ğŸ’¼ åŒäº‹</div>
            <div class="radio-chip" data-value="æ•™æœƒå¼Ÿå…„å§Šå¦¹" onclick="selectRadio(this)">â›ª æ•™æœƒå¼Ÿå…„å§Šå¦¹</div>
            <div class="radio-chip" data-value="æ··åˆ" onclick="selectRadio(this)">ğŸŒˆ æ··åˆ</div>
          </div>
        </div>

        <div class="form-group">
          <label>ç†Ÿæ‚‰ç¨‹åº¦ Familiarity</label>
          <div class="radio-group" id="rg-familiarity">
            <div class="radio-chip" data-value="åˆæ¬¡è¦‹é¢" onclick="selectRadio(this)">ğŸ‘‹ åˆæ¬¡è¦‹é¢</div>
            <div class="radio-chip" data-value="èªè­˜ä½†ä¸ç†Ÿ" onclick="selectRadio(this)">ğŸ™‚ èªè­˜ä½†ä¸ç†Ÿ</div>
            <div class="radio-chip" data-value="ç†Ÿæ‚‰" onclick="selectRadio(this)">ğŸ˜„ ç†Ÿæ‚‰</div>
          </div>
        </div>

        <div class="form-group">
          <label>æ˜¯å¦åŒ…æ‹¬å…’ç«¥ï¼Ÿ Include Children?</label>
          <div class="toggle-row">
            <div class="toggle" id="toggle-children" onclick="toggleChildren()"></div>
            <span class="toggle-label" id="toggle-children-label">ä¸åŒ…æ‹¬å…’ç«¥</span>
          </div>
          <div class="conditional" id="children-section">
            <div class="form-group">
              <label>å…’ç«¥å¹´é½¡ç¯„åœ</label>
              <input type="text" id="f-childrenAgeRange" placeholder="ä¾‹å¦‚ï¼š7-16">
            </div>
          </div>
        </div>

        <div class="step-nav">
          <div></div>
          <button class="btn btn-primary" onclick="goToStep(2)">ä¸‹ä¸€æ­¥ â†’</button>
        </div>
      </div>
    </div>

    <!-- STEP 2: Activity Settings -->
    <div class="step-content" id="step-2" style="display:none;">
      <div class="card">
        <h2>âš™ï¸ æ´»å‹•è¨­å®š Settings</h2>

        <div class="form-group">
          <label>å ´åœ° Venue</label>
          <div class="radio-group" id="rg-venue">
            <div class="radio-chip" data-value="å®¤å…§" onclick="selectRadio(this)">ğŸ  å®¤å…§ Indoor</div>
            <div class="radio-chip" data-value="å®¤å¤–" onclick="selectRadio(this)">ğŸŒ³ å®¤å¤– Outdoor</div>
            <div class="radio-chip" data-value="éƒ½å¯ä»¥" onclick="selectRadio(this)">ğŸ”„ éƒ½å¯ä»¥ Either</div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>å¯ç”¨æ™‚é–“ Available Time</label>
            <div class="radio-group" id="rg-time">
              <div class="radio-chip" data-value="30åˆ†é˜" onclick="selectRadio(this)">30 min</div>
              <div class="radio-chip" data-value="1å°æ™‚" onclick="selectRadio(this)">1 hr</div>
              <div class="radio-chip" data-value="1.5å°æ™‚" onclick="selectRadio(this)">1.5 hr</div>
              <div class="radio-chip" data-value="2å°æ™‚ä»¥ä¸Š" onclick="selectRadio(this)">2+ hr</div>
            </div>
          </div>
          <div class="form-group">
            <label>éŠæˆ²æ•¸é‡ Number of Games</label>
            <div class="radio-group" id="rg-gamecount">
              <div class="radio-chip" data-value="2" onclick="selectRadio(this)">2</div>
              <div class="radio-chip" data-value="3" onclick="selectRadio(this)">3</div>
              <div class="radio-chip" data-value="4" onclick="selectRadio(this)">4</div>
              <div class="radio-chip" data-value="5" onclick="selectRadio(this)">5</div>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label>è¼¸å‡ºèªè¨€ Language</label>
          <div class="radio-group" id="rg-language">
            <div class="radio-chip selected" data-value="ç¹é«”ä¸­æ–‡" onclick="selectRadio(this)">ç¹é«”ä¸­æ–‡</div>
            <div class="radio-chip" data-value="English" onclick="selectRadio(this)">English</div>
          </div>
        </div>

        <div class="step-nav">
          <button class="btn btn-outline" onclick="goToStep(1)">â† ä¸Šä¸€æ­¥</button>
          <button class="btn btn-primary" onclick="goToStep(3)">ä¸‹ä¸€æ­¥ â†’</button>
        </div>
      </div>
    </div>

    <!-- STEP 3: Special Requirements -->
    <div class="step-content" id="step-3" style="display:none;">
      <div class="card">
        <h2>âš ï¸ ç‰¹åˆ¥è¦æ±‚ Special Requirements</h2>

        <div class="form-group">
          <label>ç‰¹åˆ¥é™åˆ¶ï¼ˆå¯å¤šé¸ï¼‰Restrictions</label>
          <div class="chip-group" id="cg-restrictions">
            <label class="chip" onclick="toggleChip(this)">
              <input type="checkbox" value="é¿å…ç”·å¥³èº«é«”æ¥è§¸">
              ğŸš« é¿å…ç”·å¥³èº«é«”æ¥è§¸
            </label>
            <label class="chip" onclick="toggleChip(this)">
              <input type="checkbox" value="ç›¡é‡ä¸ç”¨é“å…·ï¼ˆå¦‚éœ€è¦åªç”¨æ—¥å¸¸ç‰©å“ï¼‰">
              ğŸ“¦ ç›¡é‡ä¸ç”¨é“å…·
            </label>
            <label class="chip" onclick="toggleChip(this)">
              <input type="checkbox" value="é¿å…åŠ‡çƒˆé‹å‹•">
              ğŸƒ é¿å…åŠ‡çƒˆé‹å‹•
            </label>
            <label class="chip" onclick="toggleChip(this)">
              <input type="checkbox" value="é©åˆè¡Œå‹•ä¸ä¾¿è€…åƒèˆ‡">
              â™¿ é©åˆè¡Œå‹•ä¸ä¾¿è€…
            </label>
            <label class="chip" onclick="toggleChip(this)">
              <input type="checkbox" value="é¿å…éœ€è¦é–±è®€æˆ–æ›¸å¯«çš„éŠæˆ²">
              âœï¸ é¿å…é–±è®€/æ›¸å¯«
            </label>
            <label class="chip" onclick="toggleChip(this)">
              <input type="checkbox" value="é¿å…å°·å°¬æˆ–å¤ªç§å¯†çš„äº’å‹•">
              ğŸ˜³ é¿å…å°·å°¬äº’å‹•
            </label>
          </div>
        </div>

        <div class="form-group">
          <label>å…¶ä»–ç‰¹åˆ¥è¦æ±‚ï¼ˆè‡ªç”±è¼¸å…¥ï¼‰</label>
          <textarea id="f-otherRequirements" placeholder="ä¾‹å¦‚ï¼šæœ‰ä¸€ä½è¼ªæ¤…ä½¿ç”¨è€…ã€å ´åœ°æ¯”è¼ƒå°..."></textarea>
        </div>

        <div class="form-group">
          <label>åˆ†çµ„è¦æ±‚ Grouping Rule</label>
          <div class="radio-group" id="rg-grouping">
            <div class="radio-chip" data-value="æ‰“æ•£å¤«å©¦/å®¶åº­åˆ†é–‹" onclick="selectRadio(this)">ğŸ”€ æ‰“æ•£å¤«å©¦/å®¶åº­</div>
            <div class="radio-chip" data-value="è‡ªç”±åˆ†çµ„" onclick="selectRadio(this)">ğŸ² è‡ªç”±åˆ†çµ„</div>
            <div class="radio-chip" data-value="ä¸åˆ†çµ„" onclick="selectRadio(this)">ğŸ‘¤ ä¸åˆ†çµ„</div>
          </div>
        </div>

        <div class="step-nav">
          <button class="btn btn-outline" onclick="goToStep(2)">â† ä¸Šä¸€æ­¥</button>
          <button class="btn btn-primary" onclick="goToStep(4)">ä¸‹ä¸€æ­¥ â†’</button>
        </div>
      </div>
    </div>

    <!-- STEP 4: Purpose & Debrief -->
    <div class="step-content" id="step-4" style="display:none;">
      <div class="card">
        <h2>ğŸ¯ æ´»å‹•ç›®çš„ Purpose</h2>

        <div class="form-group">
          <label>æ´»å‹•ç›®çš„ï¼ˆå¯å¤šé¸ï¼‰</label>
          <div class="chip-group" id="cg-purposes">
            <label class="chip" onclick="toggleChip(this)">
              <input type="checkbox" value="ç ´å†°èªè­˜"> ğŸ§Š ç ´å†°èªè­˜
            </label>
            <label class="chip" onclick="toggleChip(this)">
              <input type="checkbox" value="å¢é€²æ„Ÿæƒ…"> ğŸ’• å¢é€²æ„Ÿæƒ…
            </label>
            <label class="chip" onclick="toggleChip(this)">
              <input type="checkbox" value="ä¿¡ä»°åæ€"> âœï¸ ä¿¡ä»°åæ€
            </label>
            <label class="chip" onclick="toggleChip(this)">
              <input type="checkbox" value="åœ˜éšŠåˆä½œ"> ğŸ¤ åœ˜éšŠåˆä½œ
            </label>
            <label class="chip" onclick="toggleChip(this)">
              <input type="checkbox" value="ç´”ç²¹å¥½ç©"> ğŸ‰ ç´”ç²¹å¥½ç©
            </label>
            <label class="chip" onclick="toggleChip(this)">
              <input type="checkbox" value="åƒ¹å€¼è§€æ¢ç´¢"> ğŸ’¡ åƒ¹å€¼è§€æ¢ç´¢
            </label>
          </div>
        </div>

        <div class="form-group">
          <label>æ¯å€‹éŠæˆ²é™„å¸¶åæ€åˆ†äº«å•é¡Œï¼Ÿ Include Debrief?</label>
          <div class="toggle-row">
            <div class="toggle on" id="toggle-debrief" onclick="toggleDebrief()"></div>
            <span class="toggle-label" id="toggle-debrief-label">åŒ…å«åæ€å•é¡Œï¼ˆå«è–ç¶“ç¶“æ–‡ï¼‰</span>
          </div>
        </div>

        <div class="form-group">
          <label>å…¶ä»–è£œå……èªªæ˜ Additional Notes</label>
          <textarea id="f-additionalNotes" placeholder="ä¾‹å¦‚ï¼šæ˜¯é€€ä¿®æœƒçš„å…¶ä¸­ä¸€ç’°ã€æƒ³è®“å¤§å®¶æ›´å¤šèªè­˜å½¼æ­¤..."></textarea>
        </div>

        <div class="form-group">
          <label>ğŸ“§ å®Œæˆå¾Œå¯„é€åˆ° Emailï¼ˆé¸å¡«ï¼‰</label>
          <input type="email" id="f-email" placeholder="your@email.com">
          <div class="hint">ç”Ÿæˆå®Œæˆå¾Œæœƒè‡ªå‹•ç™¼é€éŠæˆ²æ‰‹å†Šåˆ°æ­¤ä¿¡ç®±</div>
        </div>

        <div class="step-nav">
          <button class="btn btn-outline" onclick="goToStep(3)">â† ä¸Šä¸€æ­¥</button>
          <button class="btn btn-primary" onclick="goToStep(5)">ç¢ºèª & é è¦½ â†’</button>
        </div>
      </div>
    </div>

    <!-- STEP 5: Confirm & Generate -->
    <div class="step-content" id="step-5" style="display:none;">
      <div class="card">
        <h2>âœ… ç¢ºèªç”Ÿæˆ Confirm</h2>
        <div id="summary-content" style="line-height: 1.8;"></div>

        <div class="step-nav" style="margin-top: 20px;">
          <button class="btn btn-outline" onclick="goToStep(4)">â† ä¿®æ”¹</button>
          <button class="btn btn-primary btn-full" id="btn-generate" onclick="generateGames()">
            ğŸ¯ ç”ŸæˆéŠæˆ²æ‰‹å†Š
          </button>
        </div>
      </div>
    </div>

    <!-- GENERATING STATE -->
    <div class="step-content" id="step-generating" style="display:none;">
      <div class="card">
        <div class="loading">
          <div class="loading-spinner"></div>
          <div class="loading-text">ğŸ¯ AI æ­£åœ¨è¨­è¨ˆéŠæˆ²...</div>
          <div class="loading-sub">é€šå¸¸éœ€è¦ 20-40 ç§’ï¼Œè«‹ç¨å€™</div>
        </div>
      </div>
    </div>

    <!-- RESULT STATE -->
    <div class="step-content" id="step-result" style="display:none;">
      <div class="card" style="padding: 15px;">
        <div class="result-actions">
          <div class="view-toggle">
            <button class="view-toggle-btn active" onclick="switchResultView('formatted', this)">ğŸ“– æ ¼å¼åŒ–</button>
            <button class="view-toggle-btn" onclick="switchResultView('markdown', this)">ğŸ“ Markdown</button>
          </div>
          <button class="btn btn-small btn-outline" onclick="copyMarkdown()">ğŸ“‹ è¤‡è£½ Markdown</button>
          <button class="btn btn-small btn-outline" onclick="openEmailModal()">ğŸ“§ ç™¼é€ Email</button>
          <button class="btn btn-small btn-secondary" onclick="resetForm()">âœ¨ å†ç”Ÿæˆä¸€çµ„</button>
        </div>

        <div id="result-formatted" class="result-content"></div>
        <div id="result-markdown" class="markdown-raw" style="display:none;"></div>
      </div>
    </div>

  </div>

  <!-- ===================================================== -->
  <!-- HISTORY VIEW -->
  <!-- ===================================================== -->
  <div class="view" id="view-history">
    <div class="card">
      <h2>ğŸ“‹ æ­·å²è¨˜éŒ„ History</h2>
      <div id="history-list">
        <div class="loading">
          <div class="loading-spinner"></div>
          <div class="loading-text">è¼‰å…¥ä¸­...</div>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- EMAIL MODAL -->
<div class="modal-overlay" id="email-modal">
  <div class="modal">
    <h3>ğŸ“§ ç™¼é€éŠæˆ²æ‰‹å†Š</h3>
    <div class="form-group">
      <label>Email åœ°å€</label>
      <input type="email" id="modal-email" placeholder="your@email.com">
    </div>
    <div class="btn-group">
      <button class="btn btn-primary" onclick="sendEmail()">ğŸ“§ ç™¼é€</button>
      <button class="btn btn-outline" onclick="closeEmailModal()">å–æ¶ˆ</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// ===== Configuration =====
const API_URL = 'https://script.google.com/macros/s/AKfycbzP6lD_L7dU3df2JJ78cP4nAamnawAyxaoIR-PxOToBZncf4-FHicmY2zXXZEwW2GpM/exec';

// ===== State =====
let currentStep = 1;
let includeChildren = false;
let includeDebrief = true;
let currentGameSetId = null;
let currentMarkdown = '';

// ===== View Switching =====
function showView(name) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.getElementById('view-' + name).classList.add('active');

  // Update nav active state
  document.querySelectorAll('.header-nav a').forEach(a => a.classList.remove('active'));
  event.target.classList.add('active');

  if (name === 'history') loadHistory();
}

// ===== Step Navigation =====
function goToStep(step) {
  if (step === 5) buildSummary();

  // Hide all step contents
  document.querySelectorAll('.step-content').forEach(s => s.style.display = 'none');
  document.getElementById('step-' + step).style.display = 'block';

  // Update progress bar
  document.querySelectorAll('.step-item').forEach(item => {
    const s = parseInt(item.dataset.step);
    item.classList.remove('active', 'done');
    if (s === step) item.classList.add('active');
    else if (s < step) item.classList.add('done');
  });

  currentStep = step;
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// ===== Radio Chips =====
function selectRadio(el) {
  const group = el.parentElement;
  group.querySelectorAll('.radio-chip').forEach(c => c.classList.remove('selected'));
  el.classList.add('selected');
}

// ===== Checkbox Chips =====
function toggleChip(el) {
  el.classList.toggle('selected');
  const cb = el.querySelector('input[type="checkbox"]');
  if (cb) cb.checked = el.classList.contains('selected');
}

// ===== Toggles =====
function toggleChildren() {
  includeChildren = !includeChildren;
  const toggle = document.getElementById('toggle-children');
  const label = document.getElementById('toggle-children-label');
  const section = document.getElementById('children-section');

  toggle.classList.toggle('on', includeChildren);
  label.textContent = includeChildren ? 'åŒ…æ‹¬å…’ç«¥ âœ“' : 'ä¸åŒ…æ‹¬å…’ç«¥';
  section.classList.toggle('show', includeChildren);
}

function toggleDebrief() {
  includeDebrief = !includeDebrief;
  const toggle = document.getElementById('toggle-debrief');
  const label = document.getElementById('toggle-debrief-label');

  toggle.classList.toggle('on', includeDebrief);
  label.textContent = includeDebrief ? 'åŒ…å«åæ€å•é¡Œï¼ˆå«è–ç¶“ç¶“æ–‡ï¼‰' : 'ä¸åŒ…å«åæ€å•é¡Œ';
}

// ===== Get Form Values =====
function getSelectedRadio(groupId) {
  const selected = document.querySelector('#' + groupId + ' .radio-chip.selected');
  return selected ? selected.dataset.value : '';
}

function getSelectedChips(groupId) {
  const chips = document.querySelectorAll('#' + groupId + ' .chip.selected');
  return Array.from(chips).map(c => c.querySelector('input').value);
}

function getFormData() {
  const restrictions = getSelectedChips('cg-restrictions');
  const otherReq = document.getElementById('f-otherRequirements').value.trim();
  const allRequirements = restrictions.concat(otherReq ? [otherReq] : []).join('ï¼›');

  return {
    ageRange: document.getElementById('f-ageRange').value.trim(),
    participantCount: document.getElementById('f-participantCount').value.trim(),
    relationship: getSelectedRadio('rg-relationship'),
    familiarity: getSelectedRadio('rg-familiarity'),
    includeChildren: includeChildren ? 'yes' : 'no',
    childrenAgeRange: includeChildren ? document.getElementById('f-childrenAgeRange').value.trim() : '',
    venue: getSelectedRadio('rg-venue'),
    availableTime: getSelectedRadio('rg-time'),
    gameCount: getSelectedRadio('rg-gamecount') || '3',
    language: getSelectedRadio('rg-language') || 'ç¹é«”ä¸­æ–‡',
    specialRequirements: allRequirements,
    groupingRule: getSelectedRadio('rg-grouping'),
    purposes: getSelectedChips('cg-purposes').join('ã€'),
    includeDebrief: includeDebrief ? 'yes' : 'no',
    additionalNotes: document.getElementById('f-additionalNotes').value.trim(),
    email: document.getElementById('f-email').value.trim()
  };
}

// ===== Summary =====
function buildSummary() {
  const d = getFormData();
  const lines = [];

  const addLine = (icon, label, value) => {
    if (value) lines.push(`<div style="margin:6px 0;"><strong>${icon} ${label}ï¼š</strong>${value}</div>`);
  };

  addLine('ğŸ‘¥', 'å¹´é½¡ç¯„åœ', d.ageRange);
  addLine('ğŸ’‘', 'é—œä¿‚', d.relationship);
  addLine('ğŸ”¢', 'äººæ•¸', d.participantCount);
  addLine('ğŸ¤', 'ç†Ÿæ‚‰ç¨‹åº¦', d.familiarity);
  if (d.includeChildren === 'yes') {
    addLine('ğŸ‘¶', 'å…’ç«¥', `åŒ…æ‹¬ï¼ˆ${d.childrenAgeRange} æ­²ï¼‰`);
  }
  addLine('ğŸ ', 'å ´åœ°', d.venue);
  addLine('â±ï¸', 'æ™‚é–“', d.availableTime);
  addLine('ğŸ®', 'éŠæˆ²æ•¸é‡', d.gameCount);
  addLine('ğŸŒ', 'èªè¨€', d.language);
  if (d.specialRequirements) addLine('âš ï¸', 'ç‰¹åˆ¥è¦æ±‚', d.specialRequirements);
  addLine('ğŸ”€', 'åˆ†çµ„', d.groupingRule);
  addLine('ğŸ¯', 'ç›®çš„', d.purposes);
  addLine('ğŸ’¬', 'åæ€å•é¡Œ', d.includeDebrief === 'yes' ? 'åŒ…å«' : 'ä¸åŒ…å«');
  if (d.additionalNotes) addLine('ğŸ“', 'è£œå……', d.additionalNotes);
  if (d.email) addLine('ğŸ“§', 'Email', d.email);

  document.getElementById('summary-content').innerHTML = lines.join('');
}

// ===== Generate =====
function generateGames() {
  const data = getFormData();
  data.action = 'generateGames';

  // Show loading
  document.querySelectorAll('.step-content').forEach(s => s.style.display = 'none');
  document.getElementById('step-generating').style.display = 'block';

  // API call via GET (encode data as JSON in URL param)
  const url = API_URL + '?action=generateGames&data=' + encodeURIComponent(JSON.stringify(data));

  fetch(url)
    .then(r => r.json())
    .then(result => {
      if (result.success) {
        currentGameSetId = result.gameSetId;
        currentMarkdown = result.markdownContent;
        showResult(result.markdownContent);

        if (result.emailError) {
          showToast('éŠæˆ²å·²ç”Ÿæˆï¼Œä½† Email ç™¼é€å¤±æ•—ï¼š' + result.emailError, 'error');
        } else if (data.email) {
          showToast('âœ… éŠæˆ²æ‰‹å†Šå·²ç™¼é€åˆ° ' + data.email, 'success');
        }
      } else {
        showToast('ç”Ÿæˆå¤±æ•—ï¼š' + result.error, 'error');
        goToStep(5);
      }
    })
    .catch(err => {
      showToast('ç¶²çµ¡éŒ¯èª¤ï¼š' + err.message, 'error');
      goToStep(5);
    });
}

// ===== Show Result =====
function showResult(markdown) {
  document.querySelectorAll('.step-content').forEach(s => s.style.display = 'none');
  document.getElementById('step-result').style.display = 'block';
  document.getElementById('step-progress').style.display = 'none';

  // Render formatted version
  document.getElementById('result-formatted').innerHTML = renderMarkdown(markdown);
  // Show raw markdown
  document.getElementById('result-markdown').textContent = markdown;
}

function switchResultView(view, btn) {
  document.querySelectorAll('.view-toggle-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');

  document.getElementById('result-formatted').style.display = view === 'formatted' ? 'block' : 'none';
  document.getElementById('result-markdown').style.display = view === 'markdown' ? 'block' : 'none';
}

// ===== Simple Markdown Renderer =====
function renderMarkdown(md) {
  let html = md;

  // Escape HTML (preserve markdown)
  html = html.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

  // Headers
  html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
  html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
  html = html.replace(/^# (.+)$/gm, '<h1>$1</h1>');

  // Bold
  html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');

  // Italic
  html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');

  // HR
  html = html.replace(/^---$/gm, '<hr>');

  // Tables
  const tableRegex = /(\|.+\|[\r\n]+)+/g;
  html = html.replace(tableRegex, function(tableBlock) {
    const rows = tableBlock.trim().split('\n').filter(r => r.trim());
    if (rows.length < 2) return tableBlock;

    let tableHtml = '<table>';
    rows.forEach((row, idx) => {
      const cells = row.split('|').filter(c => c.trim());
      // Skip separator rows
      if (cells.every(c => c.trim().match(/^[-:]+$/))) return;

      const tag = idx === 0 ? 'th' : 'td';
      tableHtml += '<tr>' + cells.map(c => `<${tag}>${c.trim()}</${tag}>`).join('') + '</tr>';
    });
    tableHtml += '</table>';
    return tableHtml;
  });

  // Ordered lists
  html = html.replace(/^(\d+)\.\s+(.+)$/gm, '<li data-num="$1">$2</li>');

  // Unordered lists
  html = html.replace(/^[-â€¢âœ”â˜]\s+(.+)$/gm, '<li>$1</li>');

  // Wrap consecutive <li> in <ol>/<ul>
  html = html.replace(/(<li[^>]*>[\s\S]*?<\/li>\n?)+/g, function(match) {
    if (match.includes('data-num=')) {
      return '<ol>' + match.replace(/ data-num="\d+"/g, '') + '</ol>';
    }
    return '<ul>' + match + '</ul>';
  });

  // Paragraphs - lines that aren't HTML tags
  html = html.replace(/^(?!<[a-z/]|$)(.+)$/gm, '<p>$1</p>');

  // Clean up empty paragraphs
  html = html.replace(/<p>\s*<\/p>/g, '');

  return html;
}

// ===== Copy & Email =====
function copyMarkdown() {
  if (!currentMarkdown) return;
  navigator.clipboard.writeText(currentMarkdown).then(() => {
    showToast('âœ… å·²è¤‡è£½ Markdown åˆ°å‰ªè²¼ç°¿', 'success');
  }).catch(() => {
    // Fallback
    const ta = document.createElement('textarea');
    ta.value = currentMarkdown;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
    showToast('âœ… å·²è¤‡è£½', 'success');
  });
}

function openEmailModal() {
  const email = document.getElementById('f-email').value.trim();
  document.getElementById('modal-email').value = email;
  document.getElementById('email-modal').classList.add('show');
}

function closeEmailModal() {
  document.getElementById('email-modal').classList.remove('show');
}

function sendEmail() {
  const email = document.getElementById('modal-email').value.trim();
  if (!email || !email.includes('@')) {
    showToast('è«‹è¼¸å…¥æœ‰æ•ˆçš„ Email åœ°å€', 'error');
    return;
  }

  if (!currentGameSetId) {
    showToast('æ‰¾ä¸åˆ°éŠæˆ²è¨˜éŒ„', 'error');
    return;
  }

  showToast('ğŸ“§ æ­£åœ¨ç™¼é€...', '');

  const url = API_URL + '?action=sendGameEmail&gameSetId=' + encodeURIComponent(currentGameSetId) + '&email=' + encodeURIComponent(email);
  fetch(url)
    .then(r => r.json())
    .then(result => {
      if (result.success) {
        showToast('âœ… å·²ç™¼é€åˆ° ' + email, 'success');
        closeEmailModal();
      } else {
        showToast('ç™¼é€å¤±æ•—ï¼š' + result.error, 'error');
      }
    })
    .catch(err => {
      showToast('ç¶²çµ¡éŒ¯èª¤ï¼š' + err.message, 'error');
    });
}

// ===== History =====
function loadHistory() {
  const listEl = document.getElementById('history-list');
  listEl.innerHTML = '<div class="loading"><div class="loading-spinner"></div><div class="loading-text">è¼‰å…¥ä¸­...</div></div>';

  const url = API_URL + '?action=listGameSets';
  fetch(url)
    .then(r => r.json())
    .then(result => {
      if (result.success && result.gameSets && result.gameSets.length > 0) {
        listEl.innerHTML = result.gameSets.map(g => `
          <div class="history-card" onclick="loadGameSet('${g.id}')">
            <div class="info">
              <h4>${g.name || 'åœ˜å»ºéŠæˆ²'}</h4>
              <p>${g.gameCount || '?'} å€‹éŠæˆ² Â· ${g.venue || ''} ${g.purposes ? 'Â· ' + g.purposes : ''}</p>
            </div>
            <div class="meta">
              ${g.createdAt ? new Date(g.createdAt).toLocaleDateString() : ''}
            </div>
          </div>
        `).join('');
      } else {
        listEl.innerHTML = '<p style="text-align:center;color:var(--text-muted);padding:30px;">é‚„æ²’æœ‰ä»»ä½•æ­·å²è¨˜éŒ„</p>';
      }
    })
    .catch(err => {
      listEl.innerHTML = '<p style="text-align:center;color:var(--danger);padding:30px;">è¼‰å…¥å¤±æ•—ï¼š' + err.message + '</p>';
    });
}

function loadGameSet(gameSetId) {
  showToast('è¼‰å…¥ä¸­...', '');

  const url = API_URL + '?action=getGameSet&gameSetId=' + encodeURIComponent(gameSetId);
  fetch(url)
    .then(r => r.json())
    .then(result => {
      if (result.success && result.gameSet.markdownContent) {
        currentGameSetId = result.gameSet.id;
        currentMarkdown = result.gameSet.markdownContent;

        // Switch to create view and show result
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById('view-create').classList.add('active');
        showResult(result.gameSet.markdownContent);
      } else {
        showToast('è¼‰å…¥å¤±æ•—', 'error');
      }
    })
    .catch(err => {
      showToast('ç¶²çµ¡éŒ¯èª¤ï¼š' + err.message, 'error');
    });
}

// ===== Reset =====
function resetForm() {
  // Show step progress again
  document.getElementById('step-progress').style.display = 'flex';

  // Reset to step 1
  goToStep(1);

  // Clear selections (keep defaults)
  currentGameSetId = null;
  currentMarkdown = '';
}

// ===== Toast =====
function showToast(message, type) {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.className = 'toast show' + (type ? ' ' + type : '');
  setTimeout(() => { toast.className = 'toast'; }, 3500);
}
</script>

</body>
</html>

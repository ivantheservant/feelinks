<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>🎯 團建遊戲生成器 Game Generator</title>
  <style>
    :root {
      --primary: #E64A19;
      --primary-dark: #BF360C;
      --primary-light: #FF8A65;
      --accent: #FF6D00;
      --success: #43A047;
      --warning: #FFA000;
      --danger: #D32F2F;
      --bg: #FFF8F0;
      --card-bg: #FFFFFF;
      --text: #3E2723;
      --text-light: #795548;
      --text-muted: #A1887F;
      --border: #FFCCBC;
      --step-inactive: #D7CCC8;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans TC", "Microsoft JhengHei", sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* ===== Header ===== */
    .header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      padding: 20px;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 12px rgba(230, 74, 25, 0.3);
    }
    .header h1 { font-size: 1.6em; margin-bottom: 4px; }
    .header p { opacity: 0.9; font-size: 0.85em; }
    .header-nav { display: flex; justify-content: center; gap: 15px; margin-top: 12px; }
    .header-nav a {
      color: rgba(255,255,255,0.85);
      text-decoration: none;
      font-size: 0.85em;
      padding: 5px 12px;
      border-radius: 20px;
      transition: all 0.2s;
    }
    .header-nav a:hover, .header-nav a.active {
      background: rgba(255,255,255,0.2);
      color: white;
    }

    .main-content { padding: 20px; max-width: 800px; margin: 0 auto; }

    /* ===== Views ===== */
    .view { display: none; }
    .view.active { display: block; }

    /* ===== Cards ===== */
    .card {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 2px 12px rgba(62, 39, 35, 0.06);
      border: 1px solid rgba(255, 204, 188, 0.3);
    }
    .card h2 { color: var(--primary); margin-bottom: 15px; font-size: 1.25em; }
    .card h3 { color: var(--text); margin: 18px 0 10px; font-size: 1.05em; }

    /* ===== Step Progress Bar ===== */
    .step-progress {
      display: flex;
      justify-content: space-between;
      margin-bottom: 25px;
      position: relative;
    }
    .step-progress::before {
      content: '';
      position: absolute;
      top: 16px;
      left: 30px;
      right: 30px;
      height: 3px;
      background: var(--step-inactive);
      z-index: 0;
    }
    .step-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      z-index: 1;
      cursor: pointer;
    }
    .step-circle {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      background: var(--step-inactive);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.85em;
      transition: all 0.3s;
      margin-bottom: 6px;
    }
    .step-item.active .step-circle { background: var(--primary); transform: scale(1.1); box-shadow: 0 3px 10px rgba(230, 74, 25, 0.3); }
    .step-item.done .step-circle { background: var(--success); }
    .step-label { font-size: 0.7em; color: var(--text-muted); text-align: center; max-width: 70px; }
    .step-item.active .step-label { color: var(--primary); font-weight: 600; }

    /* ===== Forms ===== */
    .form-group { margin-bottom: 18px; }
    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      color: var(--text-light);
      font-size: 0.92em;
    }
    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid var(--border);
      border-radius: 10px;
      font-size: 1em;
      transition: border-color 0.2s;
      background: white;
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none;
      border-color: var(--primary);
    }
    .form-group textarea { min-height: 80px; resize: vertical; }
    .form-group .hint { font-size: 0.82em; color: var(--text-muted); margin-top: 5px; }

    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 500px) { .form-row { grid-template-columns: 1fr; } }

    /* ===== Checkbox Chips ===== */
    .chip-group { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
    .chip {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 14px;
      background: #FBE9E7;
      border: 2px solid transparent;
      border-radius: 25px;
      cursor: pointer;
      transition: all 0.2s;
      user-select: none;
      font-size: 0.9em;
    }
    .chip:hover { border-color: var(--primary-light); }
    .chip.selected { background: #FFCCBC; border-color: var(--primary); color: var(--primary-dark); font-weight: 600; }
    .chip input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--primary);
      cursor: pointer;
      flex-shrink: 0;
      pointer-events: none;
    }

    /* ===== Radio Chips ===== */
    .radio-group { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
    .radio-chip {
      padding: 10px 18px 10px 14px;
      background: #FBE9E7;
      border: 2px solid transparent;
      border-radius: 25px;
      cursor: pointer;
      transition: all 0.2s;
      user-select: none;
      font-size: 0.9em;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .radio-chip::before {
      content: '';
      width: 18px;
      height: 18px;
      border: 2px solid #BCAAA4;
      border-radius: 50%;
      flex-shrink: 0;
      transition: all 0.2s;
      background: white;
    }
    .radio-chip:hover { border-color: var(--primary-light); }
    .radio-chip:hover::before { border-color: var(--primary-light); }
    .radio-chip.selected { background: var(--primary); color: white; border-color: var(--primary); font-weight: 600; }
    .radio-chip.selected::before {
      border-color: white;
      background: white;
      box-shadow: inset 0 0 0 4px var(--primary);
    }

    /* ===== Buttons ===== */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(230, 74, 25, 0.3);
    }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(230, 74, 25, 0.4); }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .btn-secondary { background: var(--text-light); color: white; }
    .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
    .btn-outline:hover { background: #FBE9E7; }
    .btn-success { background: var(--success); color: white; }
    .btn-small { padding: 8px 16px; font-size: 0.9em; }
    .btn-full { width: 100%; }
    .btn-group { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 20px; }

    /* ===== Step Navigation ===== */
    .step-nav { display: flex; justify-content: space-between; margin-top: 25px; }

    /* ===== Conditional Section ===== */
    .conditional { display: none; margin-top: 12px; padding: 15px; background: #FFF3E0; border-radius: 10px; border-left: 4px solid var(--warning); }
    .conditional.show { display: block; }

    /* ===== Loading ===== */
    .loading { text-align: center; padding: 50px 20px; }
    .loading-spinner {
      width: 50px; height: 50px;
      border: 5px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-text { color: var(--text-light); font-size: 1.05em; }
    .loading-sub { color: var(--text-muted); font-size: 0.85em; margin-top: 8px; }

    /* ===== Result Display ===== */
    .result-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
      padding: 15px;
      background: #FFF3E0;
      border-radius: 12px;
    }
    .result-content {
      background: white;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 25px;
      line-height: 1.8;
      font-size: 0.95em;
    }
    .result-content h1 { color: var(--primary-dark); margin: 25px 0 12px; font-size: 1.5em; border-bottom: 2px solid var(--border); padding-bottom: 8px; }
    .result-content h2 { color: var(--primary); margin: 20px 0 10px; font-size: 1.25em; }
    .result-content h3 { color: var(--text); margin: 15px 0 8px; font-size: 1.05em; }
    .result-content table { border-collapse: collapse; width: 100%; margin: 12px 0; }
    .result-content th, .result-content td { border: 1px solid var(--border); padding: 8px 12px; text-align: left; }
    .result-content th { background: #FBE9E7; color: var(--primary-dark); font-weight: 600; }
    .result-content hr { border: none; border-top: 2px solid var(--border); margin: 25px 0; }
    .result-content ol, .result-content ul { padding-left: 22px; margin: 8px 0; }
    .result-content li { margin-bottom: 5px; }
    .result-content blockquote { border-left: 4px solid var(--primary-light); padding: 10px 15px; margin: 10px 0; background: #FFF8F0; }

    /* ===== Markdown Raw View ===== */
    .markdown-raw {
      background: #263238;
      color: #ECEFF1;
      border-radius: 10px;
      padding: 20px;
      font-family: "SFMono-Regular", "Consolas", "Liberation Mono", monospace;
      font-size: 0.85em;
      line-height: 1.6;
      white-space: pre-wrap;
      word-wrap: break-word;
      max-height: 500px;
      overflow-y: auto;
    }

    /* ===== History List ===== */
    .history-card {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background: #FFF3E0;
      border-radius: 12px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid transparent;
    }
    .history-card:hover { background: #FFE0B2; border-color: var(--primary-light); transform: translateX(4px); }
    .history-card .info h4 { color: var(--primary-dark); margin-bottom: 4px; }
    .history-card .info p { font-size: 0.82em; color: var(--text-muted); }
    .history-card .meta { text-align: right; font-size: 0.82em; color: var(--text-muted); }

    /* ===== Toast ===== */
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s;
      max-width: 90%;
    }
    .toast.show { opacity: 1; }
    .toast.success { background: var(--success); }
    .toast.error { background: var(--danger); }

    /* ===== Toggle Switch ===== */
    .toggle-row { display: flex; align-items: center; gap: 12px; margin: 8px 0; }
    .toggle-label { font-weight: 500; }
    .toggle {
      position: relative;
      width: 50px;
      height: 26px;
      background: #D7CCC8;
      border-radius: 13px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .toggle.on { background: var(--primary); }
    .toggle::after {
      content: '';
      position: absolute;
      top: 3px;
      left: 3px;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      transition: transform 0.3s;
    }
    .toggle.on::after { transform: translateX(24px); }

    /* ===== View Toggle for Results ===== */
    .view-toggle {
      display: flex;
      background: #FBE9E7;
      border-radius: 8px;
      overflow: hidden;
    }
    .view-toggle-btn {
      padding: 8px 16px;
      border: none;
      background: none;
      cursor: pointer;
      font-size: 0.85em;
      font-weight: 500;
      color: var(--text-light);
      transition: all 0.2s;
    }
    .view-toggle-btn.active { background: var(--primary); color: white; }

    /* ===== Email Modal ===== */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .modal-overlay.show { display: flex; }
    .modal {
      background: white;
      border-radius: 16px;
      padding: 25px;
      max-width: 420px;
      width: 100%;
      box-shadow: 0 15px 40px rgba(0,0,0,0.2);
    }
    .modal h3 { color: var(--primary); margin-bottom: 15px; }
  </style>
</head>
<body>

<!-- ===== HEADER ===== -->
<div class="header">
  <h1>🎯 團建遊戲生成器</h1>
  <p>Team Building Game Generator</p>
  <div class="header-nav">
    <a href="#" class="active" onclick="showView('create')">✨ 新建</a>
    <a href="#" onclick="showView('history')">📋 歷史記錄</a>
    <a href="#" onclick="showView('sample')">👀 範例</a>
    <a href="index.html" style="opacity:0.7">← 返回 Feelinks</a>
  </div>
</div>

<div class="main-content">

  <!-- ===================================================== -->
  <!-- CREATE VIEW - Step Wizard -->
  <!-- ===================================================== -->
  <div class="view active" id="view-create">

    <!-- Step Progress -->
    <div class="step-progress" id="step-progress">
      <div class="step-item active" data-step="1" onclick="goToStep(1)">
        <div class="step-circle">1</div>
        <div class="step-label">參加者</div>
      </div>
      <div class="step-item" data-step="2" onclick="goToStep(2)">
        <div class="step-circle">2</div>
        <div class="step-label">活動設定</div>
      </div>
      <div class="step-item" data-step="3" onclick="goToStep(3)">
        <div class="step-circle">3</div>
        <div class="step-label">特別要求</div>
      </div>
      <div class="step-item" data-step="4" onclick="goToStep(4)">
        <div class="step-circle">4</div>
        <div class="step-label">目的</div>
      </div>
      <div class="step-item" data-step="5" onclick="goToStep(5)">
        <div class="step-circle">5</div>
        <div class="step-label">確認</div>
      </div>
    </div>

    <!-- STEP 1: Participants -->
    <div class="step-content" id="step-1">
      <div class="card">
        <h2>👥 參加者資料 Participants</h2>

        <div class="form-row">
          <div class="form-group">
            <label>年齡範圍 Age Range</label>
            <input type="text" id="f-ageRange" placeholder="例如：45-55" value="">
          </div>
          <div class="form-group">
            <label>預計人數 Headcount</label>
            <input type="text" id="f-participantCount" placeholder="例如：20-30" value="">
          </div>
        </div>

        <div class="form-group">
          <label>參加者關係 Relationship</label>
          <div class="radio-group" id="rg-relationship">
            <div class="radio-chip" data-value="夫婦" onclick="selectRadio(this)">💑 夫婦</div>
            <div class="radio-chip" data-value="朋友" onclick="selectRadio(this)">🤝 朋友</div>
            <div class="radio-chip" data-value="同事" onclick="selectRadio(this)">💼 同事</div>
            <div class="radio-chip" data-value="教會弟兄姊妹" onclick="selectRadio(this)">⛪ 教會弟兄姊妹</div>
            <div class="radio-chip" data-value="混合" onclick="selectRadio(this)">🌈 混合</div>
          </div>
        </div>

        <div class="form-group">
          <label>熟悉程度 Familiarity</label>
          <div class="radio-group" id="rg-familiarity">
            <div class="radio-chip" data-value="初次見面" onclick="selectRadio(this)">👋 初次見面</div>
            <div class="radio-chip" data-value="認識但不熟" onclick="selectRadio(this)">🙂 認識但不熟</div>
            <div class="radio-chip" data-value="熟悉" onclick="selectRadio(this)">😄 熟悉</div>
          </div>
        </div>

        <div class="form-group">
          <label>是否包括兒童？ Include Children?</label>
          <div class="toggle-row">
            <div class="toggle" id="toggle-children" onclick="toggleChildren()"></div>
            <span class="toggle-label" id="toggle-children-label">不包括兒童</span>
          </div>
          <div class="conditional" id="children-section">
            <div class="form-group">
              <label>兒童年齡範圍</label>
              <input type="text" id="f-childrenAgeRange" placeholder="例如：7-16">
            </div>
          </div>
        </div>

        <div class="step-nav">
          <div></div>
          <button class="btn btn-primary" onclick="goToStep(2)">下一步 →</button>
        </div>
      </div>
    </div>

    <!-- STEP 2: Activity Settings -->
    <div class="step-content" id="step-2" style="display:none;">
      <div class="card">
        <h2>⚙️ 活動設定 Settings</h2>

        <div class="form-group">
          <label>場地 Venue</label>
          <div class="radio-group" id="rg-venue">
            <div class="radio-chip" data-value="室內" onclick="selectRadio(this)">🏠 室內 Indoor</div>
            <div class="radio-chip" data-value="室外" onclick="selectRadio(this)">🌳 室外 Outdoor</div>
            <div class="radio-chip" data-value="都可以" onclick="selectRadio(this)">🔄 都可以 Either</div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>可用時間 Available Time</label>
            <div class="radio-group" id="rg-time">
              <div class="radio-chip" data-value="30分鐘" onclick="selectRadio(this)">30 min</div>
              <div class="radio-chip" data-value="1小時" onclick="selectRadio(this)">1 hr</div>
              <div class="radio-chip" data-value="1.5小時" onclick="selectRadio(this)">1.5 hr</div>
              <div class="radio-chip" data-value="2小時以上" onclick="selectRadio(this)">2+ hr</div>
            </div>
          </div>
          <div class="form-group">
            <label>遊戲數量 Number of Games</label>
            <div class="radio-group" id="rg-gamecount">
              <div class="radio-chip" data-value="2" onclick="selectRadio(this)">2</div>
              <div class="radio-chip" data-value="3" onclick="selectRadio(this)">3</div>
              <div class="radio-chip" data-value="4" onclick="selectRadio(this)">4</div>
              <div class="radio-chip" data-value="5" onclick="selectRadio(this)">5</div>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label>輸出語言 Language</label>
          <div class="radio-group" id="rg-language">
            <div class="radio-chip selected" data-value="繁體中文" onclick="selectRadio(this)">繁體中文</div>
            <div class="radio-chip" data-value="English" onclick="selectRadio(this)">English</div>
          </div>
        </div>

        <div class="step-nav">
          <button class="btn btn-outline" onclick="goToStep(1)">← 上一步</button>
          <button class="btn btn-primary" onclick="goToStep(3)">下一步 →</button>
        </div>
      </div>
    </div>

    <!-- STEP 3: Special Requirements -->
    <div class="step-content" id="step-3" style="display:none;">
      <div class="card">
        <h2>⚠️ 特別要求 Special Requirements</h2>

        <div class="form-group">
          <label>特別限制（可多選）Restrictions</label>
          <div class="chip-group" id="cg-restrictions">
            <label class="chip" onclick="toggleChip(this, event)">
              <input type="checkbox" value="避免男女身體接觸">
              🚫 避免男女身體接觸
            </label>
            <label class="chip" onclick="toggleChip(this, event)">
              <input type="checkbox" value="盡量不用道具（如需要只用日常物品）">
              📦 盡量不用道具
            </label>
            <label class="chip" onclick="toggleChip(this, event)">
              <input type="checkbox" value="避免劇烈運動">
              🏃 避免劇烈運動
            </label>
            <label class="chip" onclick="toggleChip(this, event)">
              <input type="checkbox" value="適合行動不便者參與">
              ♿ 適合行動不便者
            </label>
            <label class="chip" onclick="toggleChip(this, event)">
              <input type="checkbox" value="避免需要閱讀或書寫的遊戲">
              ✏️ 避免閱讀/書寫
            </label>
            <label class="chip" onclick="toggleChip(this, event)">
              <input type="checkbox" value="避免尷尬或太私密的互動">
              😳 避免尷尬互動
            </label>
          </div>
        </div>

        <div class="form-group">
          <label>其他特別要求（自由輸入）</label>
          <textarea id="f-otherRequirements" placeholder="例如：有一位輪椅使用者、場地比較小..."></textarea>
        </div>

        <div class="form-group">
          <label>分組要求 Grouping Rule</label>
          <div class="radio-group" id="rg-grouping">
            <div class="radio-chip" data-value="打散夫婦/家庭分開" onclick="selectRadio(this)">🔀 打散夫婦/家庭</div>
            <div class="radio-chip" data-value="自由分組" onclick="selectRadio(this)">🎲 自由分組</div>
            <div class="radio-chip" data-value="不分組" onclick="selectRadio(this)">👤 不分組</div>
          </div>
        </div>

        <div class="step-nav">
          <button class="btn btn-outline" onclick="goToStep(2)">← 上一步</button>
          <button class="btn btn-primary" onclick="goToStep(4)">下一步 →</button>
        </div>
      </div>
    </div>

    <!-- STEP 4: Purpose & Debrief -->
    <div class="step-content" id="step-4" style="display:none;">
      <div class="card">
        <h2>🎯 活動目的 Purpose</h2>

        <div class="form-group">
          <label>活動目的（可多選）</label>
          <div class="chip-group" id="cg-purposes">
            <label class="chip" onclick="toggleChip(this, event)">
              <input type="checkbox" value="破冰認識"> 🧊 破冰認識
            </label>
            <label class="chip" onclick="toggleChip(this, event)">
              <input type="checkbox" value="增進感情"> 💕 增進感情
            </label>
            <label class="chip" onclick="toggleChip(this, event)">
              <input type="checkbox" value="信仰反思"> ✝️ 信仰反思
            </label>
            <label class="chip" onclick="toggleChip(this, event)">
              <input type="checkbox" value="團隊合作"> 🤝 團隊合作
            </label>
            <label class="chip" onclick="toggleChip(this, event)">
              <input type="checkbox" value="純粹好玩"> 🎉 純粹好玩
            </label>
            <label class="chip" onclick="toggleChip(this, event)">
              <input type="checkbox" value="價值觀探索"> 💡 價值觀探索
            </label>
          </div>
        </div>

        <div class="form-group">
          <label>每個遊戲附帶反思分享問題？ Include Debrief?</label>
          <div class="toggle-row">
            <div class="toggle on" id="toggle-debrief" onclick="toggleDebrief()"></div>
            <span class="toggle-label" id="toggle-debrief-label">包含反思問題（含聖經經文）</span>
          </div>
        </div>

        <div class="form-group">
          <label>其他補充說明 Additional Notes</label>
          <textarea id="f-additionalNotes" placeholder="例如：是退修會的其中一環、想讓大家更多認識彼此..."></textarea>
        </div>

        <div class="form-group">
          <label>📧 完成後寄送到 Email（選填）</label>
          <input type="email" id="f-email" placeholder="your@email.com">
          <div class="hint">生成完成後會自動發送遊戲手冊到此信箱</div>
        </div>

        <div class="step-nav">
          <button class="btn btn-outline" onclick="goToStep(3)">← 上一步</button>
          <button class="btn btn-primary" onclick="goToStep(5)">確認 & 預覽 →</button>
        </div>
      </div>
    </div>

    <!-- STEP 5: Confirm & Generate -->
    <div class="step-content" id="step-5" style="display:none;">
      <div class="card">
        <h2>✅ 確認生成 Confirm</h2>
        <div id="summary-content" style="line-height: 1.8;"></div>

        <div class="step-nav" style="margin-top: 20px;">
          <button class="btn btn-outline" onclick="goToStep(4)">← 修改</button>
          <button class="btn btn-primary btn-full" id="btn-generate" onclick="generateGames()">
            🎯 生成遊戲手冊
          </button>
        </div>
      </div>
    </div>

    <!-- GENERATING STATE -->
    <div class="step-content" id="step-generating" style="display:none;">
      <div class="card">
        <div class="loading">
          <div class="loading-spinner"></div>
          <div class="loading-text">🎯 AI 正在設計遊戲...</div>
          <div class="loading-sub">通常需要 20-40 秒，請稍候</div>
        </div>
      </div>
    </div>

    <!-- RESULT STATE -->
    <div class="step-content" id="step-result" style="display:none;">
      <div class="card" style="padding: 15px;">
        <div class="result-actions">
          <div class="view-toggle">
            <button class="view-toggle-btn active" onclick="switchResultView('formatted', this)">📖 格式化</button>
            <button class="view-toggle-btn" onclick="switchResultView('markdown', this)">📝 Markdown</button>
          </div>
          <button class="btn btn-small btn-outline" onclick="copyMarkdown()">📋 複製 Markdown</button>
          <button class="btn btn-small btn-outline" onclick="openEmailModal()">📧 發送 Email</button>
          <button class="btn btn-small btn-secondary" onclick="resetForm()">✨ 再生成一組</button>
        </div>

        <div id="result-formatted" class="result-content"></div>
        <div id="result-markdown" class="markdown-raw" style="display:none;"></div>
      </div>
    </div>

  </div>

  <!-- ===================================================== -->
  <!-- HISTORY VIEW -->
  <!-- ===================================================== -->
  <div class="view" id="view-history">
    <div class="card">
      <h2>📋 歷史記錄 History</h2>
      <div id="history-list">
        <div class="loading">
          <div class="loading-spinner"></div>
          <div class="loading-text">載入中...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===================================================== -->
  <!-- SAMPLE VIEW -->
  <!-- ===================================================== -->
  <div class="view" id="view-sample">
    <div class="card" style="padding: 15px;">
      <div class="result-actions">
        <span style="font-weight:600; color:var(--primary); padding:8px;">👀 輸出範例 — 生成結果大概像這樣</span>
        <button class="btn btn-small btn-primary" onclick="showView('create'); document.querySelector('.header-nav a').click();">✨ 開始生成自己的</button>
      </div>
      <div class="result-content" id="sample-content"></div>
    </div>
  </div>

</div>

<!-- EMAIL MODAL -->
<div class="modal-overlay" id="email-modal">
  <div class="modal">
    <h3>📧 發送遊戲手冊</h3>
    <div class="form-group">
      <label>Email 地址</label>
      <input type="email" id="modal-email" placeholder="your@email.com">
    </div>
    <div class="btn-group">
      <button class="btn btn-primary" onclick="sendEmail()">📧 發送</button>
      <button class="btn btn-outline" onclick="closeEmailModal()">取消</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// ===== Configuration =====
const API_URL = 'https://script.google.com/macros/s/AKfycbzP6lD_L7dU3df2JJ78cP4nAamnawAyxaoIR-PxOToBZncf4-FHicmY2zXXZEwW2GpM/exec';

// ===== State =====
let currentStep = 1;
let includeChildren = false;
let includeDebrief = true;
let currentGameSetId = null;
let currentMarkdown = '';

// ===== View Switching =====
function showView(name) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.getElementById('view-' + name).classList.add('active');

  // Update nav active state
  document.querySelectorAll('.header-nav a').forEach(a => a.classList.remove('active'));
  if (event && event.target) event.target.classList.add('active');

  if (name === 'history') loadHistory();
  if (name === 'sample') renderSample();
}

// ===== Sample Data =====
const SAMPLE_MARKDOWN = `# 團契活動遊戲手冊
## 夫婦團隊建立遊戲指南
**適合 45–55 歲夫婦 · 室內活動 · 男女不需身體接觸**

---

### 設計原則
✔ 所有參加者混合分組，避免夫婦或家庭同組
✔ 男女之間不需要身體接觸
✔ 規則簡單，不需要長時間學習
✔ 盡量不需道具，如需要也只用日常簡單物品
✔ 每個遊戲附帶反思分享問題

---

# ═══════════════════════════════════════
# 第一套：成人專用遊戲（不包括兒童）
# ═══════════════════════════════════════

適合夫婦團契、小組聚會、退修會等場合使用。

---

## 遊戲一：「人生拍賣會」

| 項目 | 內容 |
|------|------|
| 人數 | 10–30 人（分 4–6 組，每組 4–5 人，打散夫婦分組） |
| 時間 | 約 25–30 分鐘（含分享） |
| 道具 | 每人一張紙、一支筆（記錄用） |
| 難度 | ★ 簡單，一分鐘內可說明規則 |

### 遊戲說明
這是一個價值觀探索遊戲。每位參加者擁有虛擬的「人生幣」1000 元，主持人會逐一拍賣不同的「人生項目」，參加者以小組為單位討論並競投。透過選擇與取捨，反思自己真正重視什麼。

### 事前準備
1. 主持人預備 10–12 個「人生拍賣項目」，寫在大紙或投影片上。
2. 項目範例：「健康的身體」、「兒女信主」、「財務自由」、「美滿婚姻」、「環遊世界」、「教會復興」、「長壽」、「智慧」、「好朋友」、「事業成功」、「住大屋」、「內心平安」。
3. 按每組人數準備紙和筆。

### 遊戲步驟
1. **分組：** 主持人用報數（1–5）或其他方式將所有人隨機分組。規則：夫婦必須分開在不同組別。
2. **說明規則：** 每組共有「人生幣」5000 元（每人 1000 元匯集）。主持人會逐一拍賣項目，每組可舉手出價，最低叫價 100 元，每次加價至少 100 元。最高出價者得到該項目。
3. **開始拍賣：** 主持人展示第一個項目，各組商討後舉手叫價。每個項目限時 1 分鐘內完成競投。
4. **記錄：** 每組指定一人記錄已花費金額和得到的項目。
5. 全部項目拍賣完後，各組分享自己買到了什麼，為什麼選擇這些。

### 主持貼士
拍賣時可以營造氣氛，例如說「健康的身體，起標價 100 元，有冇人出更高價？」。鼓勵各組在叫價前快速討論。如果遇到冷場的項目，可以適當降低起標價或加入幽默描述。

### 反思分享（Debrief）
拍賣結束後，請各組圍圈討論以下問題（約 8–10 分鐘）：
1. 你們組最想買到的是哪個項目？為什麼？
2. 有沒有哪個項目你個人很想要，但組裡其他人不同意？你們如何處理分歧？
3. 如果只能留一樣，你會保留哪個？這反映了你人生中最看重什麼？
4. 聖經說「你的財寶在哪裏，你的心也在那裏」（馬太福音六章21節）。這個遊戲讓你對自己的價值觀有什麼新發現？
5. 在小組討論中，你有沒有被別人的觀點影響或啟發？

---

## 遊戲二：「真假難辨」（Two Truths One Lie 變化版）

| 項目 | 內容 |
|------|------|
| 人數 | 10–30 人（分 4–6 組，每組 4–5 人，打散夫婦分組） |
| 時間 | 約 25–30 分鐘（含分享） |
| 道具 | 不需要任何道具 |
| 難度 | ★ 極簡單，30 秒可說明規則 |

### 遊戲說明
經典破冰遊戲的團隊版。每組派出代表說出三件關於自己的事（兩真一假），其他組別要猜出哪一件是假的。這個遊戲能促進彼此認識，也考驗觀察力和判斷力。

### 遊戲步驟
1. **分組：** 與遊戲一不同方式分組（例如按生日月份排隊後報數），確保夫婦分開。
2. **組內準備（5 分鐘）：** 每組每位成員想好三件關於自己的事——兩件真、一件假。假的那件要盡量像真的。組員可以互相幫忙想點子，但不能透露哪件是假的。
3. **開始遊戲：** 每輪由一組派出一位代表，站到前面對全場說出自己的三件事。
4. 各組討論（限時 30 秒）後舉手回答認為哪一件是假的。
5. 揭曉答案。猜對的組別得 1 分。
6. 每組輪流派出 2–3 位代表（視時間而定），最後統計總分。

### 主持貼士
鼓勵參加者選擇有趣或意想不到的真實經歷，令遊戲更有趣味。例如：「我曾經在非洲做過短宣」、「我年輕時學過跳傘」、「我會說四種語言」。提醒參加者假的那件事要說得自然，不要笑場。

### 反思分享（Debrief）
遊戲結束後，全場一起討論（約 8–10 分鐘）：
1. 你最驚訝的是誰的哪一件事？為什麼？
2. 你發現自己判斷真假時，是靠什麼線索？表情？語氣？內容的合理性？
3. 在日常生活中，我們有時也會「隱藏真實的自己」。你覺得什麼原因讓人不敢展示真實的一面？
4. 箴言十二章22節說：「說謊言的嘴，為耶和華所憎惡；行事誠實的，為他所喜悅。」在信仰群體中，「真實」為什麼重要？
5. 今天有沒有因為這個遊戲，讓你對某位弟兄姊妹有了新的認識？

---

## 遊戲三：「默契大考驗」

| 項目 | 內容 |
|------|------|
| 人數 | 10–30 人（分 4–6 組，每組 4–5 人，打散夫婦分組） |
| 時間 | 約 20–25 分鐘（含分享） |
| 道具 | 每人一張紙、一支筆 |
| 難度 | ★ 簡單，一分鐘內可說明規則 |

### 遊戲說明
主持人提出一個問題，每組所有成員同時在紙上寫下自己的答案（不可討論）。然後一起亮出答案，答案相同的人數越多，得分越高。這遊戲考驗的是默契與「換位思考」——你能否預測其他人的想法。

### 遊戲步驟
1. **分組：** 用新的方式分組（例如按姓氏筆劃排列），確保夫婦分開。
2. 主持人宣布規則：每回合我會問一個問題，大家不能討論，各自寫答案在紙上。然後同時亮出答案。
3. **計分方式：** 如果全組 5 人中有 3 人答案相同，該組得 3 分；4 人相同得 5 分；5 人全部相同得 10 分；只有 2 人相同得 1 分。
4. 進行 8–10 個回合。每回合之間可讓大家簡短反應。

### 建議題目
以下題目由淺入深，建議按此順序使用：
- 「說出一種紅色的水果」
- 「說出一個紐西蘭城市」
- 「說出一首大家都會唱的詩歌名稱」
- 「聖誕節你最先想到的一個字」
- 「說出一件你覺得夫婦最重要的事」
- 「如果只能帶一樣東西去荒島，你會帶什麼？」
- 「用一個詞形容我們教會」
- 「退休後最想做的一件事」
- 「說出聖經中你最喜愛的一個人物」
- 「用一個字形容幸福」

### 主持貼士
前幾題選擇較容易有共識的題目作為熱身，讓大家有成功感。後面的題目逐漸開放，答案更多元。當有組別全部答案一致時，可以營造驚喜氣氛大聲慶祝。

### 反思分享（Debrief）
遊戲結束後，各組內討論（約 8 分鐘）：
1. 哪一題你最有信心會跟別人一樣？結果如何？
2. 你寫答案的時候，是寫自己真正的想法，還是猜其他人會寫什麼？這兩者有衝突嗎？
3. 在教會或家庭中，「默契」是怎樣建立起來的？需要什麼條件？
4. 腓立比書二章2節說：「你們就要意念相同，愛心相同，有一樣的心思，有一樣的意念，使我的喜樂可以滿足。」合一是否代表所有人都要一樣？還是可以不同卻仍然合一？

---

## 遊戲四（加場）：「故事接龍」

| 項目 | 內容 |
|------|------|
| 人數 | 10–30 人（分 4–6 組，每組 4–5 人，打散夫婦分組） |
| 時間 | 約 20–25 分鐘（含分享） |
| 道具 | 完全不需要 |
| 難度 | ★ 極簡單，30 秒可說明規則 |

### 遊戲說明
每組成員輪流各說一句話，合力創作一個完整的故事。考驗即時反應、團隊合作和創意。全組一起站在前面向全場「表演」他們的故事。

### 遊戲步驟
1. 分組（方式同上，確保夫婦分開）。
2. 主持人給出故事開頭（每組不同），例如：「有一天，一位牧師走進了超市……」「一對夫婦決定第一次一起煮飯……」「教會旅行的巴士突然停在了一個陌生地方……」
3. 每組有 3 分鐘準備時間商討大方向（但不可寫稿）。
4. 每組到前面表演：成員一個接一個，每人說 1–2 句，接續前一個人的故事內容，合力完成一個故事。
5. 全場觀眾票選「最有創意」、「最好笑」、「最感動」的故事。

### 主持貼士
提醒參加者不要太長篇大論，每人 1–2 句就好。如果有人卡住，可以讓下一位接手。主持人可以在每組中途加入「轉折指令」增加趣味，例如突然說「這時候突然停電了！」讓下一位從這裡繼續。

### 反思分享（Debrief）
表演結束後，全場一起分享（約 8 分鐘）：
1. 在故事接龍的過程中，你有沒有遇到跟自己預期完全不同的發展？你當時的反應是什麼？
2. 要讓一個團隊的「故事」順暢，每個人需要什麼態度？
3. 在教會生活中，我們每個人其實都是在「接龍」——接續前人的工作和異象。你覺得怎樣才能接得好？
4. 哥林多前書十二章 12–14 節提到身體與肢體的比喻。在這個遊戲中，你如何體會到每個人的角色都重要？

---

# ═══════════════════════════════════════
# 第二套：親子混合遊戲（包括 7–16 歲兒童青少年）
# ═══════════════════════════════════════

適合家庭聚會、親子營會、教會家庭日等場合。所有大人和孩子混合分組，打散家庭。

**重要分組原則：** 年幼的孩子（7–10 歲）盡量平均分配到各組，每組至少有 2–3 位大人照應。避免同一家庭的成員在同一組。

---

## 遊戲一：「比手畫腳猜猜看」

| 項目 | 內容 |
|------|------|
| 人數 | 12–40 人（分 4–6 組，每組 5–7 人，大人小孩混合） |
| 時間 | 約 25–30 分鐘（含分享） |
| 道具 | 預先寫好題目的紙條（主持人準備） |
| 難度 | ★ 極簡單，孩子也能立即參與 |

### 遊戲說明
每組輪流派出一位「表演者」，抽一張題目紙條後用動作比劃出來（不可說話、不可用嘴型），同組隊友要在限時內猜出答案。大人和小孩都可以當表演者，增加趣味。

### 事前準備
1. 主持人準備 30–40 張題目紙條，分為三種難度：
   - **簡單（適合小孩表演）：**「刷牙」、「游泳」、「吃麵」、「彈鋼琴」、「騎腳踏車」、「拍照」、「煮飯」
   - **中等：**「塞車」、「遲到」、「行山」、「洗碗」、「做功課」、「釣魚」、「曬衣服」
   - **進階（適合大人表演）：**「在超市找不到想買的東西」、「第一次學開車」、「忘記結婚紀念日」、「在教會崇拜打瞌睡」
2. 將紙條分為三疊，表演者可選擇難度。進階題猜對得 3 分，中等 2 分，簡單 1 分。

### 遊戲步驟
1. **混合分組：** 用彩色貼紙或糖果顏色分組（孩子通常喜歡這種方式），確保每組有大人有小孩，家庭成員分開。
2. 每組排出上場順序，建議大人小孩交替。
3. 表演者到前面抽題目，看完後開始表演。只能用身體動作，不能說話、不能用口形、不能指向場內物品。
4. 同組隊友大聲猜答案，限時 60 秒。
5. 每組每輪派一人，進行 4–5 輪。

### 主持貼士
如果年幼的孩子表演時卡住，可以允許組內一位大人做「助手」站在旁邊一起比劃（但不能說話）。對於年齡較大的青少年，可以鼓勵他們挑戰進階題。主持人要保持節奏明快，用倒數計時增加緊張感。

### 反思分享（Debrief）
遊戲結束後，各組圍圈分享（約 8 分鐘）。大人引導，鼓勵小孩也發言：
1. 你覺得最好笑的表演是哪一個？為什麼？
2. 不能說話只能用動作表達，是什麼感覺？困難嗎？
3. 在我們的生活中，有時候也會「有口難言」。你有沒有試過想表達一件事但對方不明白的經歷？
4. （給大人思考）你覺得與孩子之間的溝通，最大的挑戰是什麼？有什麼可以改進的？
5. （給孩子思考）你覺得跟大人一組好玩嗎？你從他們身上學到了什麼？

---

## 遊戲二：「你說我畫」

| 項目 | 內容 |
|------|------|
| 人數 | 12–40 人（分 4–6 組，每組 5–7 人，大人小孩混合） |
| 時間 | 約 25–30 分鐘（含分享） |
| 道具 | 每組一疊 A4 白紙、幾支粗筆 |
| 難度 | ★ 簡單，不需要畫畫天分 |

### 遊戲說明
每組排成一列。第一位看主持人給的題目後，在紙上畫出來（不可寫字），讓第二位看圖猜測後再畫一張新圖傳給第三位……如此類推，最後一位要猜出原始題目。類似「傳話遊戲」的繪畫版。

### 遊戲步驟
1. 混合分組（確保家庭分開，大人小孩平均分配）。每組排成一列，相鄰的人面向不同方向（防止偷看）。
2. 第一位到主持人處看題目（例如「一隻貓在釣魚」、「聖誕老人塞車」、「爸爸煮飯燒焦了」）。
3. 第一位有 30 秒畫圖時間。畫完後，只給第二位看 10 秒。
4. 第二位根據看到的圖，重新畫一張（不是臨摹，而是畫自己理解的意思），再給第三位看 10 秒。
5. 如此傳遞到最後一位。最後一位看完圖後大聲說出答案。
6. 主持人展示所有圖的演變過程——通常會從原題目漸漸「走樣」，非常好笑。
7. 答案最接近原題目的組別得 3 分，第二接近 2 分，其餘 1 分。進行 3–4 輪，每輪調整排列順序。

### 主持貼士
提醒大家畫得好不好不重要，重要的是能否傳達訊息。年幼的孩子可以安排在中間位置（不是第一位或最後一位），減輕壓力。每輪結束後展示所有圖片的過程是最歡樂的時刻，要充分利用。

### 反思分享（Debrief）
遊戲結束後分享（約 8 分鐘）：
1. 訊息從第一個人傳到最後一個人，為什麼會越來越不同？
2. 你有沒有試過在生活中，明明想表達 A 意思，別人卻理解成 B？是什麼原因？
3. 這個遊戲讓你明白溝通中什麼最重要？（提示：清楚表達？耐心理解？確認對方的意思？）
4. 雅各書一章19節說：「你們各人要快快地聽，慢慢地說。」好的溝通跟「聽」有什麼關係？
5. （親子題）在家裡，你覺得爸媽/孩子最常「誤解」你的是什麼事？

---

## 遊戲三：「人體九宮格」（Tic-Tac-Toe 真人版）

| 項目 | 內容 |
|------|------|
| 人數 | 12–40 人（分 2 大隊，每隊再分小組輪流上場） |
| 時間 | 約 20–25 分鐘（含分享） |
| 道具 | 9 張椅子排成 3x3 格（或用膠帶在地上貼出九宮格）、兩種顏色的紙/布巾分辨隊伍 |
| 難度 | ★ 極簡單，任何年齡都能立刻玩 |

### 遊戲說明
在場地中央用 9 張椅子排成 3 行 3 列的九宮格。兩隊輪流派出一人「坐到」一個格子上。先連成一線（橫、直或斜）的隊伍獲勝。但每次派人前，全隊要先答對一道問答題才能上場，增加策略性和知識性。

### 事前準備
1. 在場地中央擺好 9 張椅子，排成 3x3。椅子之間留足夠空間。
2. 準備兩種顏色的圍巾或紙張（例如紅色和藍色），坐下的人手持該顏色以示辨認。
3. 準備 20–30 道問答題，涵蓋不同程度（讓大人和孩子都有機會答對）：
   - **兒童題：**「挪亞方舟上的動物是幾隻幾隻進去的？」「耶穌出生在哪個城市？」「彩虹有幾種顏色？」
   - **青少年題：**「十誡中的第五誡是什麼？」「新西蘭的首都是哪裡？」
   - **成人題：**「保羅寫了幾封書信在新約中？」「以色列的第一位國王是誰？」

### 遊戲步驟
1. 將所有人分成兩大隊（紅隊和藍隊），確保夫婦/家庭分開。每隊內部自行排出上場順序，大人小孩交替。
2. 猜拳決定先手。先手隊伍先回答問題。
3. 主持人出題（根據上場者年齡選擇難度），答對者可以選擇九宮格中一個空位坐下。答錯則換對方回答。
4. 然後換另一隊出題上場。如此交替。
5. 先連成一線的隊伍得 1 分。之後清場重新開始，進行 3–5 局。
6. 如果九格全滿但無人連線，則為平手，各得 0.5 分。

### 主持貼士
這個遊戲節奏很快，全場會非常投入地為自己隊伍加油。主持人注意選題難度要配合上場者的年齡。可以讓觀眾席的隊友大聲提示坐哪個位置（策略討論本身也很好玩）。如果有較多年幼孩子，可以調整為兩人一組上場（一大一小搭配回答）。

### 反思分享（Debrief）
比賽結束後，兩隊混合坐，一起討論（約 8 分鐘）：
1. 你們隊伍是怎樣決定每個人坐哪個位置的？有沒有出現不同意見？
2. 在團隊中，是個人能力重要，還是整體策略重要？為什麼？
3. 你有沒有注意到大人和小孩在遊戲中各有什麼強項？
4. 以弗所書四章16節提到：「全身都靠他聯絡得合式，百節各按各職，照著各體的功用彼此相助，便叫身體漸漸增長。」你覺得在教會中，大人和孩子可以怎樣互相配搭？

---

## 遊戲四（加場）：「記憶大挑戰」

| 項目 | 內容 |
|------|------|
| 人數 | 12–40 人（分 4–6 組，每組 5–7 人，大人小孩混合） |
| 時間 | 約 15–20 分鐘（含分享） |
| 道具 | 一個大托盤或桌子，15–20 件日常小物品（鑰匙、筆、杯子、手錶、橡皮擦、硬幣等），一塊大布 |
| 難度 | ★ 極簡單 |

### 遊戲說明
主持人在托盤上放置 15–20 件日常物品，讓所有組別觀察 60 秒後蓋起來。各組在限時內寫出記得的物品名稱，越多越好。這是一個大人小孩都很投入的經典記憶遊戲。

### 遊戲步驟
1. 主持人事先在托盤上擺好物品，用布蓋住。
2. 各組站在托盤周圍（確保每人都能看到），掀開布，計時 60 秒讓大家觀察。
3. 60 秒後蓋上布，各組回到座位，限時 2 分鐘在紙上寫出記得的所有物品。鼓勵大人和小孩一起回憶、分工記錄。
4. 第一輪計分後，進行第二輪：主持人趁大家不注意時偷偷拿走 3 件物品、加入 2 件新物品。再次觀察 30 秒後蓋上。
5. 第二輪要寫出：哪些物品被拿走了？哪些是新加的？答對越多得分越高。

### 主持貼士
物品可以有趣或意想不到的——例如放一張小孩的貼紙、一個奶嘴、一顆糖果。觀察時提醒大家不能拍照！組內可以分工，例如一位記左邊、一位記右邊。第二輪的「找不同」會更有挑戰性。

### 反思分享（Debrief）
遊戲結束後各組分享（約 5–8 分鐘）：
1. 你們組是怎樣合作記住這些物品的？有沒有分工？
2. 有沒有發現小孩記住了大人沒注意到的東西？（或反過來？）
3. 在生活中，我們常常「看見」但不一定「留意」。你覺得什麼讓我們對身邊的人和事更加「用心」？
4. 詩篇一百三十九篇 1–3 節說神對我們的認識是何等細緻。你有沒有為神對你的了解和記念而感恩？

---

# ═══════════════════════════════════════
# 附錄：主持人備忘
# ═══════════════════════════════════════

### 分組技巧（避免夫婦/家庭同組）
- **報數法：** 所有人圍成大圈，按 1–5（或 1–6）報數，相同數字為一組。
- **生日月份法：** 按生日月份站成一排，然後每隔幾個人分成一組。
- **糖果法：** 準備幾種顏色的糖果，隨機抽取，同顏色為一組。
- **撲克牌法：** 每人抽一張牌，同花色為一組（夫婦如果同組則交換）。

無論用什麼方法，主持人最後要目視確認沒有夫婦或家庭成員在同一組，如有則手動調換。

### 時間控制建議
一般聚會建議選 2–3 個遊戲即可，不要太趕。每個遊戲包含分享時間約 25–30 分鐘。兩個遊戲之間可以安排茶點休息。反思分享的時間很重要，不要為了趕遊戲而省略——分享才是最有價值的部分。

### 營造安全氛圍
- 強調「好玩比贏更重要」。
- 避免讓不善表達的人感到壓力——所有遊戲都是以組為單位。
- 反思問題是開放式的，沒有標準答案，每個人的分享都應該被尊重和肯定。
- 主持人帶頭示範自嘲和幽默，降低大家的防備心。`;

let sampleRendered = false;
function renderSample() {
  if (!sampleRendered) {
    document.getElementById('sample-content').innerHTML = renderMarkdown(SAMPLE_MARKDOWN);
    sampleRendered = true;
  }
}

// ===== Step Navigation =====
function goToStep(step) {
  if (step === 5) buildSummary();

  // Hide all step contents
  document.querySelectorAll('.step-content').forEach(s => s.style.display = 'none');
  document.getElementById('step-' + step).style.display = 'block';

  // Update progress bar
  document.querySelectorAll('.step-item').forEach(item => {
    const s = parseInt(item.dataset.step);
    item.classList.remove('active', 'done');
    if (s === step) item.classList.add('active');
    else if (s < step) item.classList.add('done');
  });

  currentStep = step;
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// ===== Radio Chips =====
function selectRadio(el) {
  const group = el.parentElement;
  group.querySelectorAll('.radio-chip').forEach(c => c.classList.remove('selected'));
  el.classList.add('selected');
}

// ===== Checkbox Chips =====
function toggleChip(el, event) {
  if (event) event.preventDefault(); // stop browser double-firing label→checkbox
  el.classList.toggle('selected');
  const cb = el.querySelector('input[type="checkbox"]');
  if (cb) cb.checked = el.classList.contains('selected');
}

// ===== Toggles =====
function toggleChildren() {
  includeChildren = !includeChildren;
  const toggle = document.getElementById('toggle-children');
  const label = document.getElementById('toggle-children-label');
  const section = document.getElementById('children-section');

  toggle.classList.toggle('on', includeChildren);
  label.textContent = includeChildren ? '包括兒童 ✓' : '不包括兒童';
  section.classList.toggle('show', includeChildren);
}

function toggleDebrief() {
  includeDebrief = !includeDebrief;
  const toggle = document.getElementById('toggle-debrief');
  const label = document.getElementById('toggle-debrief-label');

  toggle.classList.toggle('on', includeDebrief);
  label.textContent = includeDebrief ? '包含反思問題（含聖經經文）' : '不包含反思問題';
}

// ===== Get Form Values =====
function getSelectedRadio(groupId) {
  const selected = document.querySelector('#' + groupId + ' .radio-chip.selected');
  return selected ? selected.dataset.value : '';
}

function getSelectedChips(groupId) {
  const chips = document.querySelectorAll('#' + groupId + ' .chip.selected');
  return Array.from(chips).map(c => c.querySelector('input').value);
}

function getFormData() {
  const restrictions = getSelectedChips('cg-restrictions');
  const otherReq = document.getElementById('f-otherRequirements').value.trim();
  const allRequirements = restrictions.concat(otherReq ? [otherReq] : []).join('；');

  return {
    ageRange: document.getElementById('f-ageRange').value.trim(),
    participantCount: document.getElementById('f-participantCount').value.trim(),
    relationship: getSelectedRadio('rg-relationship'),
    familiarity: getSelectedRadio('rg-familiarity'),
    includeChildren: includeChildren ? 'yes' : 'no',
    childrenAgeRange: includeChildren ? document.getElementById('f-childrenAgeRange').value.trim() : '',
    venue: getSelectedRadio('rg-venue'),
    availableTime: getSelectedRadio('rg-time'),
    gameCount: getSelectedRadio('rg-gamecount') || '3',
    language: getSelectedRadio('rg-language') || '繁體中文',
    specialRequirements: allRequirements,
    groupingRule: getSelectedRadio('rg-grouping'),
    purposes: getSelectedChips('cg-purposes').join('、'),
    includeDebrief: includeDebrief ? 'yes' : 'no',
    additionalNotes: document.getElementById('f-additionalNotes').value.trim(),
    email: document.getElementById('f-email').value.trim()
  };
}

// ===== Summary =====
function buildSummary() {
  const d = getFormData();
  const lines = [];

  const addLine = (icon, label, value) => {
    if (value) lines.push(`<div style="margin:6px 0;"><strong>${icon} ${label}：</strong>${value}</div>`);
  };

  addLine('👥', '年齡範圍', d.ageRange);
  addLine('💑', '關係', d.relationship);
  addLine('🔢', '人數', d.participantCount);
  addLine('🤝', '熟悉程度', d.familiarity);
  if (d.includeChildren === 'yes') {
    addLine('👶', '兒童', `包括（${d.childrenAgeRange} 歲）`);
  }
  addLine('🏠', '場地', d.venue);
  addLine('⏱️', '時間', d.availableTime);
  addLine('🎮', '遊戲數量', d.gameCount);
  addLine('🌐', '語言', d.language);
  if (d.specialRequirements) addLine('⚠️', '特別要求', d.specialRequirements);
  addLine('🔀', '分組', d.groupingRule);
  addLine('🎯', '目的', d.purposes);
  addLine('💬', '反思問題', d.includeDebrief === 'yes' ? '包含' : '不包含');
  if (d.additionalNotes) addLine('📝', '補充', d.additionalNotes);
  if (d.email) addLine('📧', 'Email', d.email);

  document.getElementById('summary-content').innerHTML = lines.join('');
}

// ===== Generate =====
function generateGames() {
  const data = getFormData();
  data.action = 'generateGames';

  // Show loading
  document.querySelectorAll('.step-content').forEach(s => s.style.display = 'none');
  document.getElementById('step-generating').style.display = 'block';

  // API call via GET (encode data as JSON in URL param)
  const url = API_URL + '?action=generateGames&data=' + encodeURIComponent(JSON.stringify(data));

  fetch(url)
    .then(r => r.json())
    .then(result => {
      if (result.success) {
        currentGameSetId = result.gameSetId;
        currentMarkdown = result.markdownContent;
        showResult(result.markdownContent);

        if (result.emailError) {
          showToast('遊戲已生成，但 Email 發送失敗：' + result.emailError, 'error');
        } else if (data.email) {
          showToast('✅ 遊戲手冊已發送到 ' + data.email, 'success');
        }
      } else {
        showToast('生成失敗：' + result.error, 'error');
        goToStep(5);
      }
    })
    .catch(err => {
      showToast('網絡錯誤：' + err.message, 'error');
      goToStep(5);
    });
}

// ===== Show Result =====
function showResult(markdown) {
  document.querySelectorAll('.step-content').forEach(s => s.style.display = 'none');
  document.getElementById('step-result').style.display = 'block';
  document.getElementById('step-progress').style.display = 'none';

  // Render formatted version
  document.getElementById('result-formatted').innerHTML = renderMarkdown(markdown);
  // Show raw markdown
  document.getElementById('result-markdown').textContent = markdown;
}

function switchResultView(view, btn) {
  document.querySelectorAll('.view-toggle-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');

  document.getElementById('result-formatted').style.display = view === 'formatted' ? 'block' : 'none';
  document.getElementById('result-markdown').style.display = view === 'markdown' ? 'block' : 'none';
}

// ===== Simple Markdown Renderer =====
function renderMarkdown(md) {
  let html = md;

  // Escape HTML (preserve markdown)
  html = html.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

  // Headers
  html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
  html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
  html = html.replace(/^# (.+)$/gm, '<h1>$1</h1>');

  // Bold
  html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');

  // Italic
  html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');

  // HR
  html = html.replace(/^---$/gm, '<hr>');

  // Tables
  const tableRegex = /(\|.+\|[\r\n]+)+/g;
  html = html.replace(tableRegex, function(tableBlock) {
    const rows = tableBlock.trim().split('\n').filter(r => r.trim());
    if (rows.length < 2) return tableBlock;

    let tableHtml = '<table>';
    rows.forEach((row, idx) => {
      const cells = row.split('|').filter(c => c.trim());
      // Skip separator rows
      if (cells.every(c => c.trim().match(/^[-:]+$/))) return;

      const tag = idx === 0 ? 'th' : 'td';
      tableHtml += '<tr>' + cells.map(c => `<${tag}>${c.trim()}</${tag}>`).join('') + '</tr>';
    });
    tableHtml += '</table>';
    return tableHtml;
  });

  // Ordered lists
  html = html.replace(/^(\d+)\.\s+(.+)$/gm, '<li data-num="$1">$2</li>');

  // Unordered lists
  html = html.replace(/^[-•✔☐]\s+(.+)$/gm, '<li>$1</li>');

  // Wrap consecutive <li> in <ol>/<ul>
  html = html.replace(/(<li[^>]*>[\s\S]*?<\/li>\n?)+/g, function(match) {
    if (match.includes('data-num=')) {
      return '<ol>' + match.replace(/ data-num="\d+"/g, '') + '</ol>';
    }
    return '<ul>' + match + '</ul>';
  });

  // Paragraphs - lines that aren't HTML tags
  html = html.replace(/^(?!<[a-z/]|$)(.+)$/gm, '<p>$1</p>');

  // Clean up empty paragraphs
  html = html.replace(/<p>\s*<\/p>/g, '');

  return html;
}

// ===== Copy & Email =====
function copyMarkdown() {
  if (!currentMarkdown) return;
  navigator.clipboard.writeText(currentMarkdown).then(() => {
    showToast('✅ 已複製 Markdown 到剪貼簿', 'success');
  }).catch(() => {
    // Fallback
    const ta = document.createElement('textarea');
    ta.value = currentMarkdown;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
    showToast('✅ 已複製', 'success');
  });
}

function openEmailModal() {
  const email = document.getElementById('f-email').value.trim();
  document.getElementById('modal-email').value = email;
  document.getElementById('email-modal').classList.add('show');
}

function closeEmailModal() {
  document.getElementById('email-modal').classList.remove('show');
}

function sendEmail() {
  const email = document.getElementById('modal-email').value.trim();
  if (!email || !email.includes('@')) {
    showToast('請輸入有效的 Email 地址', 'error');
    return;
  }

  if (!currentGameSetId) {
    showToast('找不到遊戲記錄', 'error');
    return;
  }

  showToast('📧 正在發送...', '');

  const url = API_URL + '?action=sendGameEmail&gameSetId=' + encodeURIComponent(currentGameSetId) + '&email=' + encodeURIComponent(email);
  fetch(url)
    .then(r => r.json())
    .then(result => {
      if (result.success) {
        showToast('✅ 已發送到 ' + email, 'success');
        closeEmailModal();
      } else {
        showToast('發送失敗：' + result.error, 'error');
      }
    })
    .catch(err => {
      showToast('網絡錯誤：' + err.message, 'error');
    });
}

// ===== History =====
function loadHistory() {
  const listEl = document.getElementById('history-list');
  listEl.innerHTML = '<div class="loading"><div class="loading-spinner"></div><div class="loading-text">載入中...</div></div>';

  const url = API_URL + '?action=listGameSets';
  fetch(url)
    .then(r => r.json())
    .then(result => {
      if (result.success && result.gameSets && result.gameSets.length > 0) {
        listEl.innerHTML = result.gameSets.map(g => `
          <div class="history-card" onclick="loadGameSet('${g.id}')">
            <div class="info">
              <h4>${g.name || '團建遊戲'}</h4>
              <p>${g.gameCount || '?'} 個遊戲 · ${g.venue || ''} ${g.purposes ? '· ' + g.purposes : ''}</p>
            </div>
            <div class="meta">
              ${g.createdAt ? new Date(g.createdAt).toLocaleDateString() : ''}
            </div>
          </div>
        `).join('');
      } else {
        listEl.innerHTML = '<p style="text-align:center;color:var(--text-muted);padding:30px;">還沒有任何歷史記錄</p>';
      }
    })
    .catch(err => {
      listEl.innerHTML = '<p style="text-align:center;color:var(--danger);padding:30px;">載入失敗：' + err.message + '</p>';
    });
}

function loadGameSet(gameSetId) {
  showToast('載入中...', '');

  const url = API_URL + '?action=getGameSet&gameSetId=' + encodeURIComponent(gameSetId);
  fetch(url)
    .then(r => r.json())
    .then(result => {
      if (result.success && result.gameSet.markdownContent) {
        currentGameSetId = result.gameSet.id;
        currentMarkdown = result.gameSet.markdownContent;

        // Switch to create view and show result
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById('view-create').classList.add('active');
        showResult(result.gameSet.markdownContent);
      } else {
        showToast('載入失敗', 'error');
      }
    })
    .catch(err => {
      showToast('網絡錯誤：' + err.message, 'error');
    });
}

// ===== Reset =====
function resetForm() {
  // Show step progress again
  document.getElementById('step-progress').style.display = 'flex';

  // Reset to step 1
  goToStep(1);

  // Clear selections (keep defaults)
  currentGameSetId = null;
  currentMarkdown = '';
}

// ===== Toast =====
function showToast(message, type) {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.className = 'toast show' + (type ? ' ' + type : '');
  setTimeout(() => { toast.className = 'toast'; }, 3500);
}
</script>

</body>
</html>
